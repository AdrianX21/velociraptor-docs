<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content="Collecting files to the cloud…"><link rel=icon href=/images/favicon.png type=image/png><title>Triage with Velociraptor — Pt 3 :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1623592976 rel=stylesheet><link href=/css/fontawesome-all.min.css?1623592976 rel=stylesheet><link href=/css/hybrid.css?1623592976 rel=stylesheet><link href=/css/featherlight.min.css?1623592976 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1623592976 rel=stylesheet><link href=/css/auto-complete.css?1623592976 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1623592976 rel=stylesheet><link href=/css/theme.css?1623592976 rel=stylesheet><link href=/css/tabs.css?1623592976 rel=stylesheet><link href=/css/hugo-theme.css?1623592976 rel=stylesheet><link href=/css/theme-mine.css?1623592976 rel=stylesheet><link href=/css/atom-one-light.css?1623592976 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1623592976></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/><nav id=sidebar><div id=header-wrapper><div id=header><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li></ul></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/>Velociraptor Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class="dd-item
parent"><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class="dd-item active"><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Triage with Velociraptor — Pt 3</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Triage with Velociraptor — Pt 3</h1><h4 id=by-mike-cohen>By Mike Cohen</h4><p><img src=../../img/1__AN0KYVpqc581I2OYcKQ0zg.jpeg alt></p><p>This is the final part of this three part series of articles describing how to use Velociraptor to collect files from an endpoint. Our <a href=https://medium.com/@mike_89870/triage-with-velociraptor-pt-1-253f57ce96c0>first part</a> shows how we can use the Velociraptor agent in a typical client/server setting to collect artifacts from one or many endpoints at the push of a button, within seconds.</p><p><a href=https://medium.com/@mike_89870/triage-with-velociraptor-pt-2-d0f79066ca0e>Part two</a> examined what to do if Velociraptor is not already installed as an agent (or can not be remotely installed). In this case we used an accomplice user with administrator privileges (or group policy) on the endpoint to run the collector interactively — producing a zip file with the triage material within it. We left the task of transporting the file back to the investigator up to the user though. Ideally we would like to have an automated way in which the files can be transported back to us.</p><p>This article continues this theme: we devise a way for the collected file to be uploaded to a cloud storage bucket. We will write a new Velociraptor artifact with this functionality, leveraging the previously described collection artifact. It is a good example of how we may customize artifact collection in a flexible way adding arbitrary functionality to Velociraptor as we go along.</p><h4 id=setting-up-google-cloud-bucket-for-uploading>Setting up Google Cloud Bucket for uploading.</h4><p>Before we can upload files to a bucket we need to have a project in place. For this example I created a new project called “<em>velociraptor-demo</em>”:</p><p><img src=../../img/1__1DXiwQ4__gqzaYMZKSMxAfg.png alt="Create a new project">
Create a new project</p><p>Our plan is to distribute to our accomplices the packed binary as before, but this time we want Velociraptor to automatically upload results for us into our bucket.</p><p>In order to do this we need a service account with credentials allowing it to upload to our bucket. Go to <strong>IAM & Admin / Service Accounts / Create Service Account:</strong></p><p><img src=../../img/1__ZG9riz0ViCT8PgILXHuU7Q.png alt></p><p>Since the service account will be able to upload by itself (i.e. the user does not authenticate on its behalf), we need to identify it with a JSON key. The key allows Velociraptor to act as the service account on this cloud project. Clicking the Create button will download a JSON file to your system with the private key in it.</p><p><img src=../../img/1__rsKWeCDPrO9AffAuG2k__rA.png alt>
<img src=../../img/1__qGr13ir9qftvzxJUoM5D6A.png alt></p><p>Note the service account’s email address. Currently this account has no permissions at all — but we will allow it to write objects into our upload bucket later.</p><p><img src=../../img/1__EhghHAfmjbZFU2vhiPvhYA.png alt></p><p>Next we create a bucket to store our collected zip files I will call it “velociraptor-uploads-121”:</p><p><img src=../../img/1__ehJ3qfAiaUMNPXoy4mUhEg.png alt></p><p>Selecting the “Permissions” tab, we are able to add the service account as a member — we will only give it the ability to write on a bucket and create new objects. This is important since is means that the service account is unable to read or list objects in this bucket. Since we will embed the service account key in our config file we need to make sure it can not be misused to compromise collections from other machines.</p><p><img src=../../img/1__vzszs0OjRzdqMRlXbesuNw.png alt></p><h4 id=creating-and-embedding-a-customartifact>Creating and embedding a custom artifact</h4><p>Now we are ready to create our custom artifact. Our artifact will first collect the <strong>KapeFiles</strong> targets we require into a locally written zip file, and then using the above credentials, upload the zip file to the cloud. Finally we will delete the temporary file from the endpoint. As an added measure of security we specify a password on the collected zip file.</p><script src=https://gist.github.com/scudette/4eea88eb780af37c676b304168b3ffef.js></script><p>The above artifact is fairly easy to read:</p><ol><li>Using the <strong>collect()</strong> plugin we are able to collect one or more artifacts into a local zip file. We use the <strong>tempfile()</strong> function to provide a local filename for us to write on. Note that Velociraptor will clean the temp file at the end of the query automatically. We can also specify a password for encrypting the collection zip file.</li><li>The <strong>collect()</strong> plugin returns a single row with the name of the container (i.e. the Zip file we write on). We then call the <strong>upload_gcs()</strong> function on this file name to upload this file to GCS. We use the credentials we obtained earlier, bucket and project names and finally we rename the uploaded file according to the timestamp.</li></ol><p>Next we simply embed this configuration file in the binary as we did in part 2:</p><p>F:> velociraptor.exe config repack config.yaml my_velo.exe</p><p>We can send this file to our accomplice and have them run it as an administrator to simply collect everything and upload to the cloud automatically. Alternatively we can push this binary out via Group Policy Scheduled tasks as well, or even via another EDR tool — it really does not matter how we get the code executing on the endpoint.</p><p>The below screenshot shows the debug log from running the collector. We can see the container finalized, then uploaded to GCS with its hashes calculated. When Velociraptor uploads the container to GCS, Google’s server calculate the md5 and return it together with other object attributes. Velociraptor then compares this hash to the one it calculated before to ensure the file landed properly on the cloud bucket.</p><p>Finally, then the temp file is removed and the query is complete.</p><p><img src=../../img/1__PxNDr9zbvyzf__LgecPp__MQ.png alt></p><h4 id=conclusions>Conclusions</h4><p>This concludes our three part series about triaging with Velociraptor. Triaging is about collecting files quickly in order to preserve as much of the volatile machine state as possible, then quickly analyze the data for evidence of compromise.</p><p>Although Velociraptor is normally installed as a client/server so it is always available on the endpoint, it does not have to be used in this way. The key strength of Velociraptor is its flexibility and ability to adapt to any situation through the use of the powerful Velociraptor Query Language (VQL).</p><p>Users who feel comfortable writing their own VQL can adapt Velociraptor easily to evolving situations and collect new artifacts quickly. Check out the official <a href=https://www.velocidex.com/docs/vql_reference/>VQL reference</a>, <a href=https://github.com/Velocidex/velociraptor>Download the latest version</a> of Velociraptor from GitHub and join the community of power users.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1623592976></script><script src=/js/perfect-scrollbar.min.js?1623592976></script><script src=/js/perfect-scrollbar.jquery.min.js?1623592976></script><script src=/js/jquery.sticky.js?1623592976></script><script src=/js/featherlight.min.js?1623592976></script><script src=/js/highlight.pack.js?1623592976></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1623592976></script><script src=/js/learn.js?1623592976></script><script src=/js/hugo-learn.js?1623592976></script></body></html>