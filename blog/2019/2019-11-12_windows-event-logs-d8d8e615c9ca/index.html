<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.0"><meta name=description content="What do they mean?"><link rel=icon href=/images/favicon.png type=image/png><title>Windows Event Logs :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1624423892 rel=stylesheet><link href=/css/fontawesome-all.min.css?1624423892 rel=stylesheet><link href=/css/hybrid.css?1624423892 rel=stylesheet><link href=/css/featherlight.min.css?1624423892 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1624423892 rel=stylesheet><link href=/css/auto-complete.css?1624423892 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1624423892 rel=stylesheet><link href=/css/theme.css?1624423892 rel=stylesheet><link href=/css/tabs.css?1624423892 rel=stylesheet><link href=/css/hugo-theme.css?1624423892 rel=stylesheet><link href=/css/theme-mine.css?1624423892 rel=stylesheet><link href=/css/atom-one-light.css?1624423892 rel=stylesheet><link href=/css/dark.css?1624423892 rel=stylesheet><link href=/css/light.css?1624423892 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1624423892 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1624423892></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li><li data-nav-id=/vql/artifacts/ title=Artifacts class=dd-item><a href=/vql/artifacts/>Artifacts</a></li><li data-nav-id=/vql/events/ title="Event Queries" class=dd-item><a href=/vql/events/>Event Queries</a></li></ul></li><li data-nav-id=/forensic/ title="Forensic Analysis" class=dd-item><a href=/forensic/>Forensic Analysis</a><ul><li data-nav-id=/forensic/filesystem/ title="Searching Files" class=dd-item><a href=/forensic/filesystem/>Searching Files</a></li></ul></li><hr><li data-nav-id=/vql_reference/ title="VQL Reference" class=dd-item><a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a><ul><li data-nav-id=/vql_reference/basic/ title="Basic VQL functions and plugins" class=dd-item><a href=/vql_reference/basic/>Basic VQL</a></li><li data-nav-id=/vql_reference/windows/ title="Windows Specific Functionality" class=dd-item><a href=/vql_reference/windows/>Windows</a></li><li data-nav-id=/vql_reference/parsers/ title="Parsers and data extractors" class=dd-item><a href=/vql_reference/parsers/>Parsers</a></li><li data-nav-id=/vql_reference/server/ title="Server Side Functionality" class=dd-item><a href=/vql_reference/server/>Server</a></li><li data-nav-id=/vql_reference/plugin/ title="Client Side Functionality" class=dd-item><a href=/vql_reference/plugin/>Client</a></li><li data-nav-id=/vql_reference/event/ title="Event Plugins" class=dd-item><a href=/vql_reference/event/>Event Plugins</a></li><li data-nav-id=/vql_reference/experimental/ title="Experimental Functionality" class=dd-item><a href=/vql_reference/experimental/>Experimental</a></li></ul></li><li data-nav-id=/training/ title="Velociraptor Training" class=dd-item><a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/><i class="fas fa-newspaper"></i>Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/ title="Carving $USN journal entries" class=dd-item><a href=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/>Carving $USN journal entries</a></li><li data-nav-id=/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/ title="Verifying executables on Windows" class=dd-item><a href=/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/>Verifying executables on Windows</a></li><li data-nav-id=/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/ title="Scaling Velociraptor" class=dd-item><a href=/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/>Scaling Velociraptor</a></li><li data-nav-id=/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/ title="The Next Phase of Velociraptor" class=dd-item><a href=/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/>The Next Phase of Velociraptor</a></li><li data-nav-id=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/ title="Digging into process memory" class=dd-item><a href=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/>Digging into process memory</a></li><li data-nav-id=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/ title="Digging for files with Velociraptor" class=dd-item><a href=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/>Digging for files with Velociraptor</a></li><li data-nav-id=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/ title="Migrating from OSQuery to Velociraptor" class=dd-item><a href=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/>Migrating from OSQuery to Velociraptor</a></li><li data-nav-id=/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/ title="Detecting DLL Hijacking With VQL" class=dd-item><a href=/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/>Detecting DLL Hijacking With VQL</a></li><li data-nav-id=/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/ title="Disabled Event Log files" class=dd-item><a href=/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/>Disabled Event Log files</a></li><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class="dd-item
parent"><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class="dd-item active"><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li><li data-nav-id=/exchange/ title="Artifact Exchange" class=dd-item><a href=/exchange/><i class="fas fa-code"></i>Exchange</a></li></ul><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://docs.velociraptor.app/search><i class="fas fa-search"></i>Search</a></li><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github repo</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2019/2019-11-12_Windows-Event-Logs-d8d8e615c9ca.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Windows Event Logs</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Windows Event Logs</h1><h4 id=by-mike-cohen>By Mike Cohen</h4><p><img src=../../img/1____Pq____KfTKLBbQffNGN__aHg.jpeg alt></p><p>One of the most critical sources of data when responding to an incident on windows systems is the event logs. Windows event logs record security significant events.</p><p>However, unlike more traditional Unix syslogs, the Windows Event Log system is more complex and there are a number of potential problems that an investigator can run into.</p><p>In this post we explore the windows event log system from the point of view of the investigator. We then see how tools such as Velociraptor can be used to work around its limitations.</p><h4 id=responding-to-anincident>Responding to an incident</h4><p>Consider an incident occurred on one of your systems. You would like to investigate it and so collect all the event log files from <strong>C:\Windows\System32\WinEVT\Logs\*.evtx</strong>.</p><p>The logs are stored in binary format so you will need to post process the files. Luckily there are a number of tools out there that will do that for you. Here is a typical output from the <a href=https://github.com/Velocidex/evtx>dumpevtx</a> tool for a particular event from the Security.evtx log file:</p><script src=https://gist.github.com/scudette/0b88f27e258021eecf7de9b8c0861184.js></script><p>This event looks interesting but it is not quite clear what it is really talking about. We see some potentially useful items like <strong>SubjectUserSid</strong> and <strong>PrivilegeList</strong> but we are missing some critical context around this message.</p><p>Lets look at the same event with the windows Event Viewer GUI:</p><p><img src=../../img/1__T4Q8HxIiHlGTJ61EEXvI9Q.png alt></p><p>This is much better! We now know the message indicates the user was assigned some special privileges.</p><p>Where does this message come from and why is it not shown by typical EVTX parsers?</p><p>It turns out that the message of the event is not actually stored in the EVTX file at all — it is actually stored in a DLL and it is bound to the event in the log via some complicated algorithm.</p><h4 id=event-messages>Event Messages</h4><p>Windows event logs do not store the full event message. Instead an <strong>Event Provider</strong> registers a message DLL that contains the full message. The event itself simply stores the index of the message in the Message Table as the Event ID. Note that event IDs are just a number into an event table and are commonly reused by different providers. It is the unique combination of channel, provider and Event ID that identifies the message (so for example searching for Event Id 1000 yields many different unrelated messages because many providers reuse that event ID).</p><p>The figure below illustrates how the Windows Event Viewer is able to print the proper Event Message:</p><p><img src=../../img/1__PM4my0gv8exjy__F5KRhdBg.png alt="How the Windows Event Viewer displays event log messages">
How the Windows Event Viewer displays event log messages</p><p>When a user selects an event in the Event Viewer, the application reads the <strong>Provider</strong>, <strong>EventID</strong> and <strong>EventData</strong> fields from the event itself — in the above example, the Provider was <strong>Microsoft-Windows-Security-Auditing</strong>, EventID was <strong>4672</strong> and the EventData has items such as <strong>SubjectUserSid</strong> etc.</p><p>Next the event viewer consults the registry at the key <strong>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\Security\Microsoft-Windows-Security-Auditing</strong> and reads the value <strong>EventMessageFile</strong>.</p><p>That value is the location of a dll which contains the messages for this provider. On my system, the DLL is located at **%SystemRoot%\system32\adtschema.dll (**Note that many DLLs use localizations and so the dll could be located in MUI files).</p><p><img src=../../img/1__SLH4iiByHYIz8HyJyOxAEw.png alt></p><p>The DLL has a resource section with a MESSAGE_TABLE type. The event viewer then uses this to extract the message which looks like:</p><blockquote><p>Special privileges assigned to new logon.%n%nSubject:%n%tSecurity ID:%t%t%1%n%tAccount Name:%t%t%2%n%tAccount Domain:%t%t%3%n%tLogon ID:%t%t%4%n%nPrivileges:%t%t%5</p></blockquote><p>The event viewer then interpolates the EventData items into the message by their position — for example %1 is replaced with <strong>SubjectUserSid</strong> etc. Additionally %t is a tab and %n is a new line.</p><h4 id=what-could-gowrong>What could go wrong?</h4><p>The previous section examined how event logs are actually stored on the system. In practice there are a number of pitfalls with this scheme:</p><ol><li>If an EVTX file is taken from one system to another, the relevant DLL may not be present. This is more common with bespoke software that is not commonly used. In this case the investigator has no idea what the message the event is trying to convey.</li><li>If software is uninstalled from the system, the message DLL may be removed. This makes it hard to view events in the event log from the time it was installed (in a sense information is wiped from the event log).</li></ol><p>In both of these cases, the investigator will need to figure out the correct event message independently. Luckily in the age of the internet there are many web sites that catalog some of the common event ids and what they mean:</p><p><img src=../../img/1__GmXWvkFj2vFkPEqa3jSFLQ.png alt></p><p>But it is simply not practical to search every event id. For less commonly used providers the event ids may not be indexed on the web at all. In this case the investigator is left with no idea what a specific event entry means and might miss some critical evidence</p><h4 id=velociraptors-parse_evtx-vqlplugin>Velociraptor’s parse_evtx() VQL plugin</h4><p>In the latest Velociraptor release (<a href=https://github.com/Velocidex/velociraptor/releases>0.3.6</a>), the <strong>parse_evtx()</strong> plugin is now including the event messages directly in the VQL output. This automatically enriches the event log data collected by the Velociraptor host visibility tool.</p><p><img src=../../img/1__uY97EUuaI__fI3eUBQFToLg.png alt="Velociraptor can interpolate and attach the event message to every log message it relays">
Velociraptor can interpolate and attach the event message to every log message it relays</p><p>In the above we see the result of the simple VQL query:</p><p><strong>SELECT</strong> <strong>*</strong> <strong>FROM</strong> <strong>parse_evtx(</strong> filename**=**&lsquo;c:/Windows/System32/Winevt/logs/Security.evtx&rsquo;**)**</p><p>You can see an additional field now, called <strong>Message</strong> containing the event message with the Event Data interpolated into it. This provides a lot of context around what the event is supposed to do.</p><h4 id=what-about-existing-evtxfiles>What about existing EVTX files?</h4><p>In the last section we saw how Velociraptor can enrich event logs as it is forwarding them to the server but what if we have just the evtx files — possibly we just acquired the files using bulk upload artifacts such as the <strong>Windows.KapeFiles.Targets</strong> artifact?</p><p>In that case our analysis machine may not actually have the correct message dlls installed and Velociraptor may fail to retrieve the event messages.</p><p>We need a way to maintain a library of event id’s for different providers and the messages they represent. This way we can instantly look up the correct message on demand — without needing to have DLLs installed.</p><p><a href=https://www.velocidex.com/>Velocidex</a>, the company behind Velociraptor is an innovative software company crafting many free and open source digital forensics tools. In fact Velociraptor’s EVTX parsing is implemented by the <a href=https://github.com/Velocidex/evtx>Velocidex/evtx</a> project on GitHub. You should check it out!</p><p>The project releases a stand along command line tool for parsing and examining windows event log format. In this post, I would like to demonstrate the latest “extract” feature:</p><p><img src=../../img/1__ABF6klKd0xQ82TvhOEq__hw.png alt></p><p>The <strong>extract</strong> command walks all providers in the registry, gathers their message DLLs and parses the message table resource for each. Then, all the messages are stored in a sqlite database. Sqlite being the de-facto standard for portable databases can be easily consumed by other tools written in many languages. The total size of the database is modest (I have extracted all event log messages on Windows 2019 server to about 23MB sqlite file).</p><p>Now we can easily use the database to resolve our provider and event id to a message:</p><p><img src=../../img/1__SRuWlPV0wk754__jlxI2tMw.png alt></p><p>Alternatively we can simply use sqlite directly to query the database</p><p>$ sqlite3 mydb.sqlite
SQLite version 3.24.0 2018-06-04 19:24:41
Enter &ldquo;.help&rdquo; for usage hints.
sqlite> <strong>SELECT message FROM providers join messages on providers.id = messages.provider_id where providers.name = &lsquo;Microsoft-Windows-Security-Auditing&rsquo; and messages.event_id = 4672;</strong>
<em>Special privileges assigned to new logon.%n%nSubject:%n%tSecurity ID:%t%t%1%n%tAccount Name:%t%t%2%n%tAccount Domain:%t%t%3%n%tLogon ID:%t%t%4%n%nPrivileges:%t%t%5</em></p><h4 id=enriching-old-event-logfiles>Enriching old event log files</h4><p>We have shown how dumpevtx can use our sqlite database to retrieve the messages for each event id individually but this leaves us to interpolate the full data by hand — no fun indeed!</p><p>You can also use dumpevtx to export the events into JSON, and automatically resolve event IDs with the sqlite database too by providing the database with the <code>--messagedb</code> flag.</p><p>F:\>dumpevtx.exe parse &ndash;messagedb mydb.sqlite c:\Windows\System32\winevt\Logs\Security.evtx</p><p><img src=../../img/1__Uk794PvLspR__m5WX8ENDZw.png alt="Parsing the EVTX file with the assistance of the event id database. The message interpolates the Event Data into it.">
Parsing the EVTX file with the assistance of the event id database. The message interpolates the Event Data into it.</p><h4 id=conclusions>Conclusions</h4><p>The Windows Event Log system is fairly complex — it is not enough to just copy out the *.evtx files because the information content of the log is spread throughout the filesystem in DLLs and registry keys. For many event types there is enough context in the EventData or UserData fields of the event log but in many cases, without the actual message corresponding to the event ID we lose critical meaning.</p><p>It is essential therefore to include the original message for each event log. We have shown how Velociraptor is able to include this critical information automatically. We also present the dumpevtx project which allows collecting messages in a database so events can be matched up quickly and easily with their correct messages without requiring the original program that generated the message to be installed on the analyst system.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1624423892></script><script src=/js/perfect-scrollbar.min.js?1624423892></script><script src=/js/perfect-scrollbar.jquery.min.js?1624423892></script><script src=/js/jquery.sticky.js?1624423892></script><script src=/js/featherlight.min.js?1624423892></script><script src=/js/highlight.pack.js?1624423892></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1624423892></script><script src=/js/learn.js?1624423892></script><script src=/js/hugo-learn.js?1624423892></script></body></html>