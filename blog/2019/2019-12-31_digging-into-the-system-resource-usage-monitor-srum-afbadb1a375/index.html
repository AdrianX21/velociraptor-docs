<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content="Uncovering history with Velociraptor"><link rel=icon href=/images/favicon.png type=image/png><title>Digging into the System Resource Usage Monitor (SRUM) :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1623592976 rel=stylesheet><link href=/css/fontawesome-all.min.css?1623592976 rel=stylesheet><link href=/css/hybrid.css?1623592976 rel=stylesheet><link href=/css/featherlight.min.css?1623592976 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1623592976 rel=stylesheet><link href=/css/auto-complete.css?1623592976 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1623592976 rel=stylesheet><link href=/css/theme.css?1623592976 rel=stylesheet><link href=/css/tabs.css?1623592976 rel=stylesheet><link href=/css/hugo-theme.css?1623592976 rel=stylesheet><link href=/css/theme-mine.css?1623592976 rel=stylesheet><link href=/css/atom-one-light.css?1623592976 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1623592976></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/><nav id=sidebar><div id=header-wrapper><div id=header><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li></ul></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/>Velociraptor Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class="dd-item
parent"><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class="dd-item active"><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Digging into the System Resource Usage Monitor (SRUM)</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#uncovering-history-with-velociraptor>Uncovering history with Velociraptor</a><ul><li></li><li><a href=#the-execution-stats-source>The Execution Stats source</a></li><li><a href=#application-resource-usage>Application Resource Usage</a></li></ul></li><li><a href=#hunting-the-srum-database>Hunting the SRUM database</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#training>Training</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Digging into the System Resource Usage Monitor (SRUM)</h1><h2 id=uncovering-history-with-velociraptor>Uncovering history with Velociraptor</h2><h4 id=by-mike-cohen>By Mike Cohen</h4><p><img src=../../img/0_yFgW11ar3mogfljd.jpg alt></p><p>Commonly in many incident response scenarios we need to gather evidence of program executions. For example, a phishing email delivering malware was sent to a user — did the user click on it? Did the malware run? was the email forwarded to any other users?</p><p>One of the most useful sources of evidence of execution on Windows is the System Resource Usage Monitor (SRUM). It was first described by Yogesh Khatri in the seminal paper “<a href=https://www.sciencedirect.com/science/article/pii/S1742287615000031>Forensic implications of System Resource Usage Monitor (SRUM) data in Windows 8</a>”.</p><p>SRUM is a feature in modern Windows systems which collect statistics on execution of binaries. The information is stored in an Extensible Storage Engine (ESE) database. ESE is Microsoft’s proprietary single file database format, acting similarly to SQLLite, as a default storage engine for many applications — including the SRUM database.</p><p>As from the <a href=https://github.com/Velocidex/velociraptor/releases/tag/v0.3.7>0.3.7 release of Velociraptor</a>, an ESE parser is built into the client, allowing VQL artifacts to directly query ESE databases. This opens up the exciting possibility of extracting and querying information from the SRUM database directly on the endpoint.</p><p>Although this post will not go into detail on SRUM itself (This is covered in detail <a href=https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1492184583.pdf>elsewhere</a>), I will describe how Velociraptor’s SRUM artifact can be used to hunt efficiently across many thousands of endpoints to collect evidence relevant to DFIR investigations.</p><p>Have you ever noticed the windows task manager’s “App History” tab?</p><p><img src=../../img/1_1t_puy5xiAPvR4XUosSQtg.png alt="The Task Manager App History tab"><em>The Task Manager App History tab</em></p><p>This tab shows running counts of many applications, broken by user that ran them, including network traffic, and total CPU time. Where does the information come from?</p><p>It turns out that the SRUM database is stored within tables inside the ESE database at <em>%windir%\System32\sru\SRUDB.dat.</em></p><p>Let’s examine Velociraptor’s <strong>Windows.Forensics.SRUM</strong> artifact</p><p><img src=../../img/1_Ajiq0F2RaIoqhj8PnuoCvA.png alt></p><p>The artifact contains several sources — examining a different table within the SRUM ESE database. As can be seen, the ESE database is parsed using Velociraptor’s raw NTFS parser since it is usually locked while the system is running. The artifact allows filtering for a specific application name by regular expression.</p><p>The SRUM database actually contains many tables collecting different runtime telemetry. Some of these tables are not publicly documented but may still contain valuable information. It is worthwhile inspecting the raw database file using an external tool (e.g. <a href=https://www.nirsoft.net/utils/ese_database_view.html>Nirsoft **ESEDatabaseView</a>**). The <strong>Windows.Forensics.SRUM</strong> artifact will by default upload the raw ESE file to the server as well as parse it.</p><p>To demonstrate the artifact, I am now going to collect it from one of my endpoints.</p><p><img src=../../img/1_tQOsldVH7wYGPV56wr0xBA.png alt></p><p>I simply search for my endpoint in the GUI, then click* “Collect More Artifacts” *and search for **SRUM** in the search box. I then add this artifact and click “**Next**” to launch it.</p><p><img src=../../img/1_WimaboQJfGvgXKNY6HeCEQ.png alt></p><p>The above shows that the endpoint took around 80 seconds to collect the entire artifact. This includes uploading the 28MB SRUM database, parsing some of the tables in it, and uploading the parsed results.</p><p><img src=../../img/1_fG5W7kOMtrmnB3mnGuWyeQ.png alt></p><p>Viewing the logs generated by the executing query give an indication of how the query is progressing.</p><h3 id=the-execution-stats-source>The Execution Stats source</h3><p>Let&rsquo;s inspect a sample from the “Execution Stats” source</p><p><img src=../../img/1_3lM3jXI47Z1eDQVjoLSfYQ.png alt></p><p>We get some interesting information, such as the time an application ran (this is determined by the <strong>EndTime</strong> and <strong>DurationMS</strong> — the **Timestamp **column actually refers to when the ESE record was written which may be some time later), the user who ran it, and the duration it was executing. Sometimes the information also includes valid network transfer count which might be useful for some investigations (e.g. exfiltration).</p><h3 id=application-resource-usage>Application Resource Usage</h3><p>This artifact source stores cumulative information about the running executable. Therefore it can not be used to determine exact start time (The Timestamp field corresponds to when the record was written to the ESE database). The advantage here is that the full path is provided, making it easy to search for executables running from unusual locations (e.g. temp folders and network drives).</p><p><img src=../../img/1_RLUyUIKBk5VHpHwIlOMAKQ.png alt></p><h2 id=hunting-the-srum-database>Hunting the SRUM database</h2><p>Sometimes we need to determine which endpoint in our fleet has run a particular binary — perhaps with a unique name. For example, a phishing campaign might launch a trojan malware with a specific name.</p><p>To simulate this I copied a binary to the user’s temp folder with the unique name “sdfjhsdfc.exe”. I then ran it for a while.</p><p>Next, I created a hunt, but this time, instead of dumping the entire SRUM table, I filtered the results by the name of the binary.</p><p><img src=../../img/1_KGdoKsM1v3RcqRhqREVueg.png alt></p><p>Within minutes I was able to determine exactly which user executed the binary, and on which endpoint. If a machine is not online when I first launched the hunt, it will run the hunt when it next connected to the server and deliver its results later.</p><p><img src=../../img/1_p7m7XfByE0RzuaeCB-GEfw.png alt></p><h2 id=conclusions>Conclusions</h2><p>SRUM is an excellent source of evidence of execution of binaries. In practice we often see upwards of 60 days of evidence within the ESE database — so it goes back quite a long time!</p><p>There is a wealth of information available within the SRUM database, but current Velociraptor artifacts have some limitations:</p><ol><li><p>The data written to the SRUM ESE database is first cached in the registry and then flushed to the database periodically (This is why much of the time the <strong>Timestamp</strong> field will be much later than the <strong>EndTime)</strong>. Currently Velociraptor’s artifacts are not able to parse the registry cache so very recent executions will probably be missed.</p></li><li><p>Currently Velociraptor only parses a few tables from the SRUM database, but many additional tables appear to be useful.</p></li></ol><p>These limitations are likely to improve in future as more artifacts are written to fully extract information the SRUM database.</p><h2 id=training>Training</h2><p>If you happen to be in Sydney or Melbourne and would like to learn more about incident response techniques such as the SRUM database and how to apply them with Velociraptor, consider joining us in our <a href=https://www.velocidex.com/training/>upcoming training events</a>.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1623592976></script><script src=/js/perfect-scrollbar.min.js?1623592976></script><script src=/js/perfect-scrollbar.jquery.min.js?1623592976></script><script src=/js/jquery.sticky.js?1623592976></script><script src=/js/featherlight.min.js?1623592976></script><script src=/js/highlight.pack.js?1623592976></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1623592976></script><script src=/js/learn.js?1623592976></script><script src=/js/hugo-learn.js?1623592976></script></body></html>