<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Digging for files with Velociraptor :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1624319483 rel=stylesheet><link href=/css/fontawesome-all.min.css?1624319483 rel=stylesheet><link href=/css/hybrid.css?1624319483 rel=stylesheet><link href=/css/featherlight.min.css?1624319483 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1624319483 rel=stylesheet><link href=/css/auto-complete.css?1624319483 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1624319483 rel=stylesheet><link href=/css/theme.css?1624319483 rel=stylesheet><link href=/css/tabs.css?1624319483 rel=stylesheet><link href=/css/hugo-theme.css?1624319483 rel=stylesheet><link href=/css/theme-mine.css?1624319483 rel=stylesheet><link href=/css/atom-one-light.css?1624319483 rel=stylesheet><link href=/css/dark.css?1624319483 rel=stylesheet><link href=/css/light.css?1624319483 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1624319483 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1624319483></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li><li data-nav-id=/vql/artifacts/ title=Artifacts class=dd-item><a href=/vql/artifacts/>Artifacts</a></li><li data-nav-id=/vql/events/ title="Event Queries" class=dd-item><a href=/vql/events/>Event Queries</a></li></ul></li><li data-nav-id=/forensic/ title="Forensic Analysis" class=dd-item><a href=/forensic/>Forensic Analysis</a><ul><li data-nav-id=/forensic/filesystem/ title="Searching Files" class=dd-item><a href=/forensic/filesystem/>Searching Files</a></li></ul></li><hr><li data-nav-id=/vql_reference/ title="VQL Reference" class=dd-item><a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a><ul><li data-nav-id=/vql_reference/basic/ title="Basic VQL functions and plugins" class=dd-item><a href=/vql_reference/basic/>Basic VQL</a></li><li data-nav-id=/vql_reference/windows/ title="Windows Specific Functionality" class=dd-item><a href=/vql_reference/windows/>Windows</a></li><li data-nav-id=/vql_reference/parsers/ title="Parsers and data extractors" class=dd-item><a href=/vql_reference/parsers/>Parsers</a></li><li data-nav-id=/vql_reference/server/ title="Server Side Functionality" class=dd-item><a href=/vql_reference/server/>Server</a></li><li data-nav-id=/vql_reference/plugin/ title="Client Side Functionality" class=dd-item><a href=/vql_reference/plugin/>Client</a></li><li data-nav-id=/vql_reference/event/ title="Event Plugins" class=dd-item><a href=/vql_reference/event/>Event Plugins</a></li><li data-nav-id=/vql_reference/experimental/ title="Experimental Functionality" class=dd-item><a href=/vql_reference/experimental/>Experimental</a></li></ul></li><li data-nav-id=/training/ title="Velociraptor Training" class=dd-item><a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/><i class="fas fa-newspaper"></i>Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class="dd-item
parent"><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/ title="Carving $USN journal entries" class=dd-item><a href=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/>Carving $USN journal entries</a></li><li data-nav-id=/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/ title="Verifying executables on Windows" class=dd-item><a href=/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/>Verifying executables on Windows</a></li><li data-nav-id=/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/ title="Scaling Velociraptor" class=dd-item><a href=/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/>Scaling Velociraptor</a></li><li data-nav-id=/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/ title="The Next Phase of Velociraptor" class=dd-item><a href=/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/>The Next Phase of Velociraptor</a></li><li data-nav-id=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/ title="Digging into process memory" class=dd-item><a href=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/>Digging into process memory</a></li><li data-nav-id=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/ title="Digging for files with Velociraptor" class="dd-item
parent
active"><a href=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/>Digging for files with Velociraptor</a></li><li data-nav-id=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/ title="Migrating from OSQuery to Velociraptor" class=dd-item><a href=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/>Migrating from OSQuery to Velociraptor</a></li><li data-nav-id=/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/ title="Detecting DLL Hijacking With VQL" class=dd-item><a href=/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/>Detecting DLL Hijacking With VQL</a></li><li data-nav-id=/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/ title="Disabled Event Log files" class=dd-item><a href=/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/>Disabled Event Log files</a></li><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class=dd-item><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://docs.velociraptor.app/search><i class="fas fa-search"></i>Search</a></li><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github repo</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Digging for files with Velociraptor</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#searching-for-files-using-windowssearchfilefinder>Searching for files using Windows.Search.FileFinder</a></li><li><a href=#scanning-the-master-file-table>Scanning the Master File Table</a></li><li><a href=#searching-the-usn-journal>Searching the USN journal</a></li><li><a href=#hunting-the-entire-network>Hunting the entire network</a></li><li><a href=#conclusions>Conclusions</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Digging for files with Velociraptor</h1><p>One of the most common questions in digital forensics is:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>Is a file with a specific filename currently present on this system or was it in the past?
</code></pre></div><p>There are many scenarios that lead to this question, from theft of IP by rogue employees, to drive by downloads from malicious websites or even victims of phishing emails. Often we need to scope this question to the entire network (Which machines had this file?) or potentially 10s of thousands endpoints.</p><p>This post recounts some of the techniques we can use within Velociraptor to answer this question. Most of these techniques should be very familiar to DFIR practitioners, but we will discuss how they are implemented in Velociraptor specifically.</p><p>For this post I will create a text file with a unique name Abagnale.txt and I will attempt to find it on my test system.</p><p><img src=../../img/1u0_dhIcf9zdcRdO0x1rAdw.png alt></p><h3 id=searching-for-files-using-windowssearchfilefinder>Searching for files using Windows.Search.FileFinder</h3><p>The first artifact we can use to search for files is the aptly named FileFinder artifact (There are variants for Linux/MacOS and Windows). I will simply add a new collection, search for the file finder and select the <code>Windows.Search.FileFinder</code>.</p><p><img src=../../img/1YD4Zee8PdP8nw3b-mcFDeQ.png alt></p><p>Next I will configure the artifact parameters.</p><p><img src=../../img/13ebC-8_xkdROGTsmuCoreg.png alt></p><p>The FileFinder artifact uses a glob expression to find files through the filesystem. A glob expression uses simple wildcards to match files by filename. In Velociraptor a <code>**</code> glob expression means recursively descend into subdirectories, so in our case the glob expression <code>C:\**\Abagnale*</code> will enumerate all files in the C: drive to locate the file of interest.</p><p><img src=../../img/1xW9fQn8L_pKG5SgTvencrA.png alt></p><p>Globbing through all files took 109 seconds on my test VM and returned two hits (my original text file and a lnk file created by notepad itself):</p><p><img src=../../img/1Udz5uUX3NEzT4mY-757ajw.png alt></p><h3 id=scanning-the-master-file-table>Scanning the Master File Table</h3><p>On Windows, the NTFS filesystem is almost ubiquitous. NTFS uses a special hidden file called the $MFT to store all metadata on all files (such as their filenames, size, dates etc). Metadata is stored in the $MFT within MFT entries — fixed size data structures stored back to back in the $MFT file.</p><p>Therefore, by scanning the $MFT file and parsing all MFT entries, we are able to enumerate all files’ metadata on the disk.</p><p>Velociraptor offers an artifact called <code>Windows.NTFS.MFT</code> that will enumerate all entries within the $MFT filtering out only the relevant ones.</p><p><img src=../../img/1l-xgDXReDeWyKK_A7wAm9w.png alt></p><p>I will again proceed to configure the artifact parameters. This time I am able to filter the filename by a regular expression. I will just search for all files with filenames containing the word <strong>Abagnale</strong> .</p><p><img src=../../img/1zoTSgpXbFFktbI-b14k9fg.png alt></p><p>Again this artifact found the same 2 files as the previous one</p><p><img src=../../img/1EB6S8u1baKQ2h7Qv4bTpww.png alt></p><p>So how is the MFT search method different from the Glob method?</p><p>Parsing the MFT tends to be faster than using the APIs in a glob when searching over the entire disk (87 sec vs 109 sec), although if you know that the files can only be in a more confined part of the disk (e.g. inside the C:\Users directory) then the glob method is faster since it is looking at fewer files.</p><p>However, the MFT search may be able to detect deleted files. When a file is deleted in NTFS the MFT entry is marked as unallocated and can be reused at any time, but until it does, the old data structures are still present and will be parsed by the MFT parser.</p><p>Additionally the MFT parser has access to the <strong>$FILENAME</strong> stream’s timestamps and so can report those as well. Timestamps in the <strong>$FILENAME</strong> streams (Shown in the above results as Created0x30, LastModified0x30 etc) can not be altered by timestomping tools and so are more reliable indicators of when the file was created or modified.</p><h3 id=searching-the-usn-journal>Searching the USN journal</h3><p>While the previous two methods were great for detecting files that are currently present on the endpoint, what if the file was since deleted? I mentioned that the MFT parser may still find evidence of a deleted file in unallocated MFT entries, but this will only happen if the entry is not reused by the system for something else.</p><p>Luckily, Windows keeps another record of file operations in the NTFS USN journal. I wrote in details previously about <a href=https://medium.com/velociraptor-ir/the-windows-usn-journal-f0c55c9010e>the USN journal</a> but for our purposes it is sufficient to know that file operations are continuously written by the system into a journal file internal to the NTFS filesystem (so it is not generally altered by adversaries).</p><p>Velociraptor contains a built-in parser for the USN journal which is made available via the <code>Windows.Forensics.Usn</code> artifact. I will select this artifact for collection as before</p><p><img src=../../img/1-hox0Mi6qUTpbkIsrGjKMQ.png alt></p><p>I now select “Configure Parameters” where I can specify a path regular expression.</p><p><img src=../../img/1E4JaMVWTzWPB7ghefsKOZQ.png alt></p><p>This time the artifact returns 7 rows in 29 seconds</p><p><img src=../../img/1nvuwmAxUDjDOC1V2Abwopg.png alt></p><p>Let’s take a look at the rows returned from this query</p><p><img src=../../img/1qkHHGevfBzluJPeTcHBlSw.png alt></p><p>Since the USN journal stores metadata about file operations, we see each time the file was interacted with by a program. This is not exactly the same as the previous results which just show the final state of the file.</p><p>For example, if the file was edited at one point in time and then edited again at a later time, the USN journal will show 2 separate interactions with the file, but the previous artifacts will only show the last modified time. This can be significant for some investigations, in particular if the file is deleted.</p><p>Typically we find the USN journal is kept for around 2–3 weeks by the system, providing excellent visibility of past activities.</p><h3 id=hunting-the-entire-network>Hunting the entire network</h3><p>Previously we collected the artifacts on a single host. However, in some investigations we need to determine if any machine in our network contains the file in question.</p><p>Velociraptor hunts are specifically designed to coordinate collections of the same artifact across the entire fleet. I will create a new hunt and give it a description, then proceed to select the <code>Windows.Forensics.Usn</code> artifact configuring its parameters as before.</p><p><img src=../../img/1pV6gUITH1IO1rCM2ok28ug.png alt></p><p>Running the hunt over a small network returns results within minutes</p><p><img src=../../img/1ivnEtqt-UnZG2kUldMdScA.png alt></p><p>While it may seem that a USN journal scan of an entire network is an expensive operation, in reality it places very little load on the server.</p><p>The server simply collects the result sets from running the VQL query across each endpoint in the deployment. Since these artifacts are highly targeted in returning only positive hits for the files in question the total number of rows returned is pretty small. In this hunt, most of the heavy lifting is done by the endpoints themselves — this is the secret for Velociraptor’s scalability!</p><h3 id=conclusions>Conclusions</h3><p>In this post we looked at some of the common ways to determine if a file was present on a system. Each method has advantages and disadvantages and this article explored when you should use one method over another. You can of course, just use all methods at the same time, and interpret their results accordingly.</p><p>All the described methods are very quick ranging from under 30 seconds for a USN journal scan, to a couple of minutes for a large glob operation. Using Velociraptor we can perform an exhaustive search of a large 10–20k endpoint deployment in minutes. This unprecedented agility and scalability is rather unique in an open source DFIR tool.</p><p>To play with these artifacts yourself, take<a href=https://github.com/Velocidex/velociraptor> Velociraptor for a spin</a>! It is a available on GitHub under an open source license. As always please file issues on the bug tracker or ask questions on our mailing list <a href=mailto:velociraptor-discuss@googlegroups.com>velociraptor-discuss@googlegroups.com</a> . You can also chat with us directly on discord <a href=https://www.velocidex.com/discord>https://www.velocidex.com/discord</a></p><p>If you want to know more about Velociraptor, VQL and how to use it effectively to hunt across the enterprise, consider enrolling for the next available training course at <a href=https://www.velocidex.com/training/>https://www.velocidex.com/training/</a>.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1624319483></script><script src=/js/perfect-scrollbar.min.js?1624319483></script><script src=/js/perfect-scrollbar.jquery.min.js?1624319483></script><script src=/js/jquery.sticky.js?1624319483></script><script src=/js/featherlight.min.js?1624319483></script><script src=/js/highlight.pack.js?1624319483></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1624319483></script><script src=/js/learn.js?1624319483></script><script src=/js/hugo-learn.js?1624319483></script></body></html>