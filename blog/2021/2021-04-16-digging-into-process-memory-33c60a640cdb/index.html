<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Digging into process memory :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1624580897 rel=stylesheet><link href=/css/fontawesome-all.min.css?1624580897 rel=stylesheet><link href=/css/hybrid.css?1624580897 rel=stylesheet><link href=/css/featherlight.min.css?1624580897 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1624580897 rel=stylesheet><link href=/css/auto-complete.css?1624580897 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1624580897 rel=stylesheet><link href=/css/theme.css?1624580897 rel=stylesheet><link href=/css/tabs.css?1624580897 rel=stylesheet><link href=/css/hugo-theme.css?1624580897 rel=stylesheet><link href=/css/theme-mine.css?1624580897 rel=stylesheet><link href=/css/atom-one-light.css?1624580897 rel=stylesheet><link href=/css/dark.css?1624580897 rel=stylesheet><link href=/css/light.css?1624580897 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1624580897 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1624580897></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script></script></head><body data-url=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/self-signed/>Self Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/cloud/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/cloud/>Cloud Deployment</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/resources/>Performance</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL functions and plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific Functionality</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers and data extractors</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side Functionality</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side Functionality</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental Functionality</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Velociraptor Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Velociraptor Blog</a></div><ul><li data-nav-id=https://docs.velociraptor.app/blog/2021/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/blog/2021/>2021</a></div><ul><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/>Carving $USN journal entries</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-06-09-verifying-executables-on-windows-1b3518122d3c/>Verifying executables on Windows</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-04-29-scaling-velociraptor-57acc4df76ed/>Scaling Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-04-21-the-next-phase-of-velociraptor-bf696c2c3491/>The Next Phase of Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/ class="dd-item parent active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/>Digging into process memory</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-02-13-digging-for-files-with-velociraptor-a1c0a21e242b/>Digging for files with Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-02-03-migrating-from-osquery-to-velociraptor-d4143799953f/>Migrating from OSQuery to Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-02-02-detecting-dll-hijacking-with-vql-e9a735354257/>Detecting DLL Hijacking With VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-01-29-disabled-event-log-files-a3529a08adbe/>Disabled Event Log files</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ class=dd-item><div><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/blog/2020/>2020</a></div><ul><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ class=dd-item><div><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ class=dd-item><div><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ class=dd-item><div><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ class=dd-item><div><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ class=dd-item><div><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ class=dd-item><div><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ class=dd-item><div><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ class=dd-item><div><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ class=dd-item><div><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ class=dd-item><div><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ class=dd-item><div><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ class=dd-item><div><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ class=dd-item><div><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ class=dd-item><div><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ class=dd-item><div><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ class=dd-item><div><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/blog/2019/>2019</a></div><ul><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ class=dd-item><div><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ class=dd-item><div><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ class=dd-item><div><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ class=dd-item><div><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ class=dd-item><div><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ class=dd-item><div><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ class=dd-item><div><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ class=dd-item><div><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/2019/2019-03-02/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div><ul></ul></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github repo</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/blog/2021/2021-04-16-digging-into-process-memory-33c60a640cdb/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Digging into process memory</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#direct-access-to-process-memory>Direct access to process memory</a></li><li><a href=#determining-process-environment-variables>Determining process environment variables</a></li><li><a href=#detecting-etw-subversion>Detecting ETW subversion.</a></li><li><a href=#conclusions>Conclusions</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Digging into process memory</h1><p>Unlike traditional dead disk forensic tools, Velociraptor’s main advantage is that it is capable of directly looking at volatile system state, such as running processes, open files and currently connected sockets. This class of forensic artifacts are called Volatile Artifacts since they change rapidly as the system operates — processes can start and stop quickly, files can be closed etc.</p><p>Traditionally, acquiring volatile artifacts meant taking a raw physical memory image, and then analyzing this with a memory analysis framework such as <a href=https://github.com/volatilityfoundation/volatility>Volatility</a> or <a href=https://github.com/google/rekall>Rekall</a>. These frameworks reassemble the contents of physical memory into higher level abstractions, like processes, threads, registry content etc.</p><p>While at first it might appear that a physical memory image contains a perfect snapshot of the running state of a system, this is not typically the case. The physical memory image only contains those pages currently locked into physical memory — however, modern operating systems use virtual memory to represent process and kernel memory address spaces. Each virtual memory address may refer to either paged out memory (i.e. only present in the page file) or memory mapped files (i.e. only present on the file system in e.g. dll or executable files), neither of which are typically included in a physical memory image.</p><p>Additionally, most physical memory images obtained in a DFIR setting, contains acquisition smear (i.e. the memory is changing during the acquisition process). This smear leads to inconsistencies, making memory analysis from physical memory samples generally a hit or miss affair.</p><p>For DFIR purposes it is preferable to extract data directly from the running system, rather than rely on fragile memory analysis. For example, to obtain a list of processes, it is always more reliable to use the system APIs than to take a full memory image, ship it off the endpoint, and then use a framework like Volatility to extract the same data from the raw image.</p><p>Many of the same techniques implemented in Volatility for physical memory analysis can also be implemented directly on the endpoint using OS APIs. Velociraptor already contains plugins such as “vad”, “pslist”, “modules”, “handles”, “objtree” etc.</p><p>Consider the identification of malicious processes running in memory. Many modern tools use memory only injection, where malicious code is added to processes but is never written to disk. Detecting this type of malware requires inspection of process memory using for example a Yara signature.</p><p>For example, <a href=https://malpedia.caad.fkie.fraunhofer.de/>Malpedia</a> contains Yara signatures for common malware families derived from automated identification of common code blocks. We can apply these signatures to detect memory injected <a href=https://malpedia.caad.fkie.fraunhofer.de/details/win.cobalt_strike>Cobalt Strike beacon</a> by simply scanning each process address space and reporting any hits.</p><p>Velociraptor included bindings to libyara’s process scanning capabilities for a while now, exposed through the VQL plugin proc_yara() and usable through artifacts such as <a href=https://github.com/Velocidex/velociraptor/blob/master/artifacts/definitions/Windows/Detection/ProcessMemory/CobaltStrike.yaml>Windows.Detection.ProcessMemory.CobaltStrike</a>.</p><h3 id=direct-access-to-process-memory>Direct access to process memory</h3><p>Since release 0.5.8, Velociraptor provides direct access to process memory via the “process” <a href=https://www.velocidex.com/docs/user-interface/investigating_clients/virtual_filesystem/#filesystem-accessors>accessor</a>. This allows any plugins and functions that normally operate on files to also operate on process memory, as if the process memory was just another file.</p><p>To demonstrate this new accessor, I will write “this is a test” in notepad without saving the file on disk (so the string exists only in memory). I will then write some VQL to detect this string in the process memory of notepad</p><p><img src=../../img/1jhU1ZpOf3ArKtHQsES5UpA.png alt></p><p>In the above example, I am iterating over all processes with a name matching “notepad” and then applying a yara signature over their process address space. The “process” accessor allows me to open the process represented by the filename “/<pid>” as if it was a file. The <code>yara()</code> plugin (which normally operates on files) will just see process memory as another file to scan.</p><p>I can then also extract some context around the hits to see if the hit is a false positive.</p><h3 id=determining-process-environment-variables>Determining process environment variables</h3><p>When a process is launched it receives environment variables that often affect the way the launched program behaves. I was curious to see if it is possible to determine the environment variables that a process is launched with?</p><p>On windows, each process is started with a <a href=https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb>Process Environment Block</a>. This data structure is populated by the OS before the process is created and contains important information about the proces. Processes can extract this information at runtime. The process environment variables are stored in the PEB too and therefore we can parse these out from each process’s memory.</p><p>Velociraptor has a powerful binary parser built in, as was described previously in the post “<a href=https://velociraptor.velocidex.com/parsing-binary-files-d31114a41f14>Parsing binary files</a>”. Having the process memory exposed via an accessor allows us to apply this parser to process memory via a VQL query.</p><p>If you are interested in the details, check out the VQL for the <code>Windows.Forensics.ProcessInfo</code> artifact <a href=https://github.com/Velocidex/velociraptor/blob/master/artifacts/definitions/Windows/Forensics/ProcessInfo.yaml>here</a>, but here is the result of collecting the process information (including each process’s environment variables) from my system</p><p><img src=../../img/1uuWWzOGWgSnIg_4Or8JLrQ.png alt></p><h3 id=detecting-etw-subversion>Detecting ETW subversion.</h3><p>Recently I read Adam Chester’s <a href=https://blog.xpnsec.com/hiding-your-dotnet-complus-etwenabled/>blog post</a> where he described his finding that the .NET ETW provider can simply be disabled by setting the <code>COMPlus_ETWEnabled</code> environment variable to 0. This is dramatically demonstrated by using process hacker to inspect the .NET assemblies of a powershell process.</p><p><img src=../../img/1GCGVJTqyGR9Hc66F6cFiJg.png alt></p><p>When the <code>COMPlus_ETWEnabled</code> environment variable is set to “0”, process hacker will be unable to inspect the loaded assemblies, since it relies on ETW support to do so and this is disabled within the running powershell process.</p><p>While this anti-detection technique is very simple for attackers to implement — they simply set an environment variable before launching the target binary, it should be very easy for us to detect it, using the following heuristics</p><blockquote><p>Iterate over all processes, and if any process has an environment variable starting with “COMPlus_” then it is suspicious.</p></blockquote><p>Our VQL can take advantage of the existing <code>Windows.Forensics.ProcessInfo</code> artifact and simply inspect each process’s environment dictionary</p><p><img src=../../img/1QgWxuYVpwR0yVpqq8LnPkA.png alt></p><p>In the above query we extract each process and its environment dictionary from the <code>Windows.Forensics.ProcessInfo</code> artifact, then iterate over each key and value using the <em>items()</em> plugin, filtering any keys beginning with “COMPlus”.</p><p>To convert this VQL into a detection, we now encapsulate the query in an artifact and hunt all our endpoints for processes that have the environment variable set. In practice, there should not be any legitimate reason to switch off the .NET ETW provider, so if we see this variable set in the environment, it is a very strong signal and requires further investigation.</p><h3 id=conclusions>Conclusions</h3><p>This post introduced the “process” accessor, which exposes process memory to all VQL plugins that can usually access files. The process accessor allows us to implement memory analysis techniques on running processes in real time, safely, quickly and reliably, without needing to resort to acquiring and analysing full physical memory images. This provides unprecedented visibility into the state of the endpoint and forms the basis for novel detection and hunting possibilities.</p><p>To use this feature yourself, take<a href=https://github.com/Velocidex/velociraptor> Velociraptor for a spin</a>! It is a available on GitHub under an open source license. As always please file issues on the bug tracker or ask questions on our mailing list <a href=mailto:velociraptor-discuss@googlegroups.com>velociraptor-discuss@googlegroups.com</a> . You can also chat with us directly on discord <a href=https://www.velocidex.com/discord>https://www.velocidex.com/discord</a></p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1624580897></script><script src=/js/perfect-scrollbar.min.js?1624580897></script><script src=/js/perfect-scrollbar.jquery.min.js?1624580897></script><script src=/js/jquery.sticky.js?1624580897></script><script src=/js/featherlight.min.js?1624580897></script><script src=/js/highlight.pack.js?1624580897></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1624580897></script><script src=/js/learn.js?1624580897></script><script src=/js/hugo-learn.js?1624580897></script></body></html>