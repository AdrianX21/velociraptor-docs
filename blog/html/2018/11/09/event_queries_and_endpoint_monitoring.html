<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content="In previous posts we have seen how Velociraptor can run artifacts to
collect information from hosts. For example, we can collect WMI
queries, user accounts and files.

However it would be super awesome to be able to do this collection in
real time, as soon as an event of interest appears on the host, we
would like to have that collected on the server. This post describes
the new event monitoring framework and shows how Velociraptor can
collect things such as event logs, process execution and more in real
time.
"><link rel=icon href=/images/favicon.png type=image/png><title>Event Queries and Endpoint Monitoring :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1623743078 rel=stylesheet><link href=/css/fontawesome-all.min.css?1623743078 rel=stylesheet><link href=/css/hybrid.css?1623743078 rel=stylesheet><link href=/css/featherlight.min.css?1623743078 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1623743078 rel=stylesheet><link href=/css/auto-complete.css?1623743078 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1623743078 rel=stylesheet><link href=/css/theme.css?1623743078 rel=stylesheet><link href=/css/tabs.css?1623743078 rel=stylesheet><link href=/css/hugo-theme.css?1623743078 rel=stylesheet><link href=/css/theme-mine.css?1623743078 rel=stylesheet><link href=/css/atom-one-light.css?1623743078 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1623743078 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1623743078></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/html/2018/11/09/event_queries_and_endpoint_monitoring.html><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){alert("Switch to dark mode")}</script><div class="btn btn-default ThemeSelector" onclick=darkmode()><i class="fas fa-moon"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li><li data-nav-id=/vql/artifacts/ title=Artifacts class=dd-item><a href=/vql/artifacts/>Artifacts</a></li></ul></li><li data-nav-id=/vql_reference/ title="VQL Reference" class=dd-item><a href=/vql_reference/>VQL Reference</a><ul><li data-nav-id=/vql_reference/basic/ title="Basic VQL functions and plugins" class=dd-item><a href=/vql_reference/basic/>Basic VQL</a></li><li data-nav-id=/vql_reference/windows/ title="Windows Specific Functionality" class=dd-item><a href=/vql_reference/windows/>Windows</a></li><li data-nav-id=/vql_reference/parsers/ title="Parsers and data extractors" class=dd-item><a href=/vql_reference/parsers/>Parsers</a></li><li data-nav-id=/vql_reference/server/ title="Server Side Functionality" class=dd-item><a href=/vql_reference/server/>Server</a></li><li data-nav-id=/vql_reference/plugin/ title="Client Side Functionality" class=dd-item><a href=/vql_reference/plugin/>Client</a></li><li data-nav-id=/vql_reference/event/ title="Event Plugins" class=dd-item><a href=/vql_reference/event/>Event Plugins</a></li><li data-nav-id=/vql_reference/experimental/ title="Experimental Functionality" class=dd-item><a href=/vql_reference/experimental/>Experimental</a></li></ul></li><li data-nav-id=/training/ title="Velociraptor Training" class=dd-item><a href=/training/>Training</a></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/>Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class=dd-item><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://docs.velociraptor.app/search><i class="fas fa-search"></i> Search</a></li><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Event Queries and Endpoint Monitoring</span></div><div class=progress><div class=wrapper><nav id=TableOfContents></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Event Queries and Endpoint Monitoring</h1><p>Why monitor endpoint events? Recording end point event information on
the server gives a bunch of advantages. For one, the server keeps a
record of historical events, which makes going back to search for these
easy as part of an incident response activity.</p><p>For example, Velociraptor can keep a running log of process execution
events for all clients, on the server. If a particular executable is
suspected to be malicious, we can now go back and search for the
execution of that process in the past on the infected machine (for
establishing the time of infection), as well as search the entire
deployment base for the same binary execution to be able identify
lateral movement and wider compromises.</p><h1 id=how-are-events-monitored>How are events monitored?</h1><p>Velociraptor relies heavily on VQL queries. A VQL query typically
produces a single table of multiple rows. For example, the query:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>SELECT Name, CommandLine FROM pslist()
</code></pre><p>Returns a single row of all running processes, and then returns.</p><p>However, VQL queries do not have to terminate at all. If the VQL plugin
they are calling does not terminate, the VQL query will continue to run
and pass events in partial results to the VQL caller.</p><p>Event queries are just regular VQL queries which do not terminate
(unless cancelled) returning rows whenever an event is generated.</p><p><img src=1.png alt=image></p><p>Consider the parse_evtx() plugin. This plugin parses an event log file
and returns all events in it. We can then filter events and return
specific events of interest. The following query returns all the service
installation events and terminates:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>F:\&gt;velociraptor.exe query &quot;SELECT EventData, System.TimeCreated.SystemTime from
   parse_evtx(filename='c:/windows/system32/winevt/logs/system.evtx') where
   System.EventId.value = '7045'&quot;
[
 {
  &quot;EventData&quot;: {
   &quot;AccountName&quot;: &quot;&quot;,
   &quot;ImagePath&quot;: &quot;system32\\DRIVERS\\VBoxGuest.sys&quot;,
   &quot;ServiceName&quot;: &quot;VirtualBox Guest Driver&quot;,
   &quot;ServiceType&quot;: &quot;kernel mode driver&quot;,
   &quot;StartType&quot;: &quot;boot start&quot;
  },
  &quot;System.TimeCreated.SystemTime&quot;: &quot;2018-11-10T06:32:34Z&quot;
 }
]
</code></pre><p>The query specifically looks at the 7045 event <a href="http://www.eventid.net/display.asp?eventid=7045&source=service+control+manager">"A service was
installed in the
system"</a></p><p>Lets turn this query into an event query:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>F:\&gt;velociraptor.exe query &quot;SELECT EventData, System.TimeCreated.SystemTime from
   watch_evtx(filename='c:/windows/system32/winevt/logs/system.evtx') where
   System.EventId.value = '7045'&quot; --max_wait 1
[
  &quot;EventData&quot;: {
    &quot;AccountName&quot;: &quot;&quot;,
    &quot;ImagePath&quot;: &quot;C:\\Users\\test\\AppData\\Local\\Temp\\pmeFF0E.tmp&quot;,
    &quot;ServiceName&quot;: &quot;pmem&quot;,
    &quot;ServiceType&quot;: &quot;kernel mode driver&quot;,
    &quot;StartType&quot;: &quot;demand start&quot;
  },
  &quot;System.TimeCreated.SystemTime&quot;: &quot;2018-11-10T04:57:35Z&quot;
  }
]
</code></pre><p>The watch_evtx() plugin is the event watcher equivalent of the
parse_evtx() plugin. If you ran the above query, you will notice that
Velociraptor does not terminate. Instead it will show all existing
service installation events in the log file, and then just wait in the
console.</p><p>If you then install a new service (in another terminal), for example
using winpmem.exe -L, a short time later you should see the event
reported by Velociraptor as in the above example. You will notice that
the watch_evtx() plugin emits event logs as they occur, but
Velociraptor will try to group the events into batches. The max_wait
flag controls how long to wait before releasing a partial result set.</p><h1 id=employing-event-queries-for-client-monitoring>Employing event queries for client monitoring</h1><p>The above illustrates how event queries work, but to actually be able to
use these we had to implement the Velociraptor event monitoring
framework.</p><p>Normally, when we launch a CollectVQL flow, the client executes the
query and returns the result to the flow. Clearly since event queries
never terminate, we can not run them in series (because the client will
never be able to do anything else). The Velociraptor client has a table
of executing event queries which are run in a separate thread. As these
queries return more results, the results are sent back to the server.</p><p>We also wanted to be able to update the events the clients are
monitoring on the fly (without a client restart). Therefore we needed a
way to be able to update the client's event table. This simply cancels
current event queries, and installs new queries in their place.</p><p><img src=2.png alt=image></p><p>As events are generated by the Event Table, they are sent back to the
server into the Monitoring flow. This flow is automatically created for
each client. The monitoring flow simply writes events into the client's
VFS. Therefore, events are currently simply recorded for each client. In
future there will be a mechanism to post process event and produce
alerts based on these.</p><h1 id=process-execution-logs>Process Execution logs</h1><p>One of the most interesting event plugins is the WMI eventing plugin.
This allows Velociraptor to install a temporary WMI event listener. For
example, we can install a listener for new process creation:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>// Convert the timestamp from WinFileTime to Epoch.
SELECT timestamp(epoch=atoi(
  string=Parse.TIME_CREATED) / 10000000 - 11644473600 ) as Timestamp,
  Parse.ParentProcessID as PPID,
  Parse.ProcessID as PID,
  Parse.ProcessName as Name, {
    SELECT CommandLine
    FROM wmi(
      query=&quot;SELECT * FROM Win32_Process WHERE ProcessID = &quot; +
          format(format=&quot;%v&quot;, args=Parse.ProcessID),
      namespace=&quot;ROOT/CIMV2&quot;)
  } AS CommandLine
  FROM wmi_events(
       query=&quot;SELECT * FROM __InstanceCreationEvent WITHIN 1 WHERE
              TargetInstance ISA 'Win32_Process'&quot;,
       wait=5000000,   // Do not time out.
       namespace=&quot;ROOT/CIMV2&quot;)
</code></pre><p>The wmi_events() plugin installs an event listener into WMI and
therefore receives events from the OS about new process creation events.
Unfortunately these events, do not contain a lot of information about
the process. They only provide the ProcessID but not the full command
line. The above query executes a second subquery to retrieve the command
line for the process. We also parse the timestamp and convert it into a
more standard epoch based timestamp.</p><h1 id=specifying-what-should-the-client-monitor>Specifying what should the client monitor</h1><p>We have seen how Event VQL queries can generate events for the server.
However, this is difficult for Velociraptor's end users to directly
use. Who can really remember the full query?</p><p>As we have shown previously, Velociraptor's Artifacts are specifically
designed to solve this issue. Artifacts encapsulate a VQL query so it
can be called by name alone.</p><p>For example, the Windows.Events.ProcessCreation artifact encapsulates
the above query in one easy to remember name.</p><p>To specify what clients should collect, users simply need to name the
event artifacts that should be monitored. Currently this is done in the
server configuration (in future this may be done via the GUI).</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>Events:
  artifacts:
  - Windows.Events.ServiceCreation
  - Windows.Events.ProcessCreation
  version: 1
</code></pre><p>The event table version should be incremented each time the monitored
event list is updated. This forces all clients to refresh their event
tables.</p><h1 id=how-does-it-look-like-in-the-gui>How does it look like in the GUI?</h1><p>The Monitoring flow simply writes files into the client's VFS. This
allows these to be downloaded and post processed outside of
Velociraptor.</p><p><img src=3.png alt=image></p><h1 id=conclusions>Conclusions</h1><p>Adding event monitoring to Velociraptor is a great step forward. Even
just keeping the logs around is extremely helpful for incident response.
There is a lot of value in things like process execution logging, and
remote event log forwarding. We will cover some more examples of event
log monitoring in future blog posts. Until then, have a play and provide
feedback as usual by filing issues and feature requests.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1623743078></script><script src=/js/perfect-scrollbar.min.js?1623743078></script><script src=/js/perfect-scrollbar.jquery.min.js?1623743078></script><script src=/js/jquery.sticky.js?1623743078></script><script src=/js/featherlight.min.js?1623743078></script><script src=/js/highlight.pack.js?1623743078></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1623743078></script><script src=/js/learn.js?1623743078></script><script src=/js/hugo-learn.js?1623743078></script></body></html>