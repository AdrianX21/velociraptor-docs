<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content="There has been a lot of interest lately in &#34;Agentless hunting&#34;
especially using PowerShell.  This blog post explores an agentless
deployment scenario, where we do not want to install Velociraptor
permanently on the end point, but rather push it to end points
temporarily to collect specific artifacts.
"><link rel=icon href=/images/favicon.png type=image/png><title>Agentless hunting with Velociraptor :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1623592976 rel=stylesheet><link href=/css/fontawesome-all.min.css?1623592976 rel=stylesheet><link href=/css/hybrid.css?1623592976 rel=stylesheet><link href=/css/featherlight.min.css?1623592976 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1623592976 rel=stylesheet><link href=/css/auto-complete.css?1623592976 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1623592976 rel=stylesheet><link href=/css/theme.css?1623592976 rel=stylesheet><link href=/css/tabs.css?1623592976 rel=stylesheet><link href=/css/hugo-theme.css?1623592976 rel=stylesheet><link href=/css/theme-mine.css?1623592976 rel=stylesheet><link href=/css/atom-one-light.css?1623592976 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1623592976></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/blog/html/2019/03/02/agentless_hunting_with_velociraptor.html><nav id=sidebar><div id=header-wrapper><div id=header><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class=dd-item><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li></ul></li><li data-nav-id=/blog/ title="Velociraptor Blog" class="dd-item
parent"><a href=/blog/>Velociraptor Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class=dd-item><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Agentless hunting with Velociraptor</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#creating-a-network-share>Creating a network share</a></li><li><a href=#creating-the-group-policy-object>Creating the group policy object.</a></li><li><a href=#persistence>Persistence</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Agentless hunting with Velociraptor</h1><p>There has been a lot of interest lately in Agentless hunting especially
using PowerShell. There are many reasons why Agentless hunting is
appealing - there are already a ton of endpoint agents and yet another
one may not be welcome. Somtimes we need to deploy endpoint agents as
part of a DFIR engagement and we may not want to permanently install yet
another agent on end points.</p><p>This blog post explores an agentless deployment scenario, where we do
not want to install Velociraptor permanently on the end point, but
rather push it to end points temporarily to collect specific artifacts.
The advantage of this method is that there are no permanent changes to
the end point, as nothing is actually installed. However, we do get the
full power of Velociraptor to collect artifacts, hunt for evil and
more...</p><h1 id=agentless-velociraptor>Agentless Velociraptor</h1><p>Normally when deploying Velociraptor as a service, the binary is copied
to the system and a service is installed. The service ensures that the
binary is restarted when the system reboots, and so Velociraptor is
installed on a permanent basis.</p><p>However in the agentless deployment scenario we simply run the binary
from a network share using group policy settings. The downside to this
approach is that the endpoint needs to be on the domain network to
receive the group policy update (and have the network share accessible)
before it can run Velociraptor. When we run in Agentless mode we are
really after collecting a bunch of artifacts via hunts and then exiting</p><ul><li>the agent will not restart after a reboot. So this method is suitable
for quick hunts on corporate (non roaming) assets.</li></ul><p>In this post I will use Windows 2019 Server but this should also work on
any older version.</p><h2 id=creating-a-network-share>Creating a network share</h2><p>The first step is to create a network share with the Velociraptor binary
and its configuration file. We will run the binary from the share in
this example, but for more reliability you may want to copy the binary
into e.g. a temp folder on the end point in case the system becomes
disconnected from the domain. For quick hunts though it should be fine.</p><p>We create a directory on the server (I will create it on the domain
controller but you should probably not do that - find another machine to
host the share).</p><p><img src=1.png alt=image></p><p>I created a directory C:\\Users\\Deployment and ensured that it is
read only. I have shared the directory as the name Deployment.</p><p>I now place the Velociraptor executable and client config file in that
directory and verify that I can run the binary from the network share.
The binary should be accessible via
`\\\\DC\Deployment\velociraptor.exe`:</p><p><img src=2.png alt=image></p><h2 id=creating-the-group-policy-object>Creating the group policy object.</h2><p>Next we create the group policy object which forces all domain connected
machines to run the Velociraptor client. We use the Group Policy
Management Console:</p><p><img src=3.png alt=image></p><p>Select the OU or the entire domain and click "Create New GPO":</p><p><img src=4.png alt=image></p><p>Now right click the GPO object and select "Edit":</p><p><img src=5.png alt=image></p><p>We will create a new scheduled task. Rather than schedule it at a
particular time, we will select to run it immediately. This will force
the command to run as soon as the endpoint updates its group policy
settings (i.e. we do not want to wait for the next reboot of the
endpoint).</p><p><img src=6.png alt=image></p><p>Next we give the task a name and a description. In order to allow
Velociraptor to access raw devices (e.g. to collect memory or NTFS
artifacts) we can specify that the client will run at
NT_AUTHORITY\\SYSTEM privileges, and run without any user being
logged on. It is also worth ticking the "hidden" checkbox here to
prevent a console box from appearing.</p><p><img src=7.png alt=image></p><p>Next click the Actions tab and add a new action. This is where we launch
the Velociraptor client. The program will simply be launched from the
share (i.e. \\\\\\\\DC\\Deployment\\velociraptor.exe) and we
give it the arguments allowing it to read the provided configuration
file (i.e.
--config \\\\\\\\DC\\Deployment\\client.config.yaml client -v).</p><p><img src=8.png alt=image></p><p>In the setting tab we can control how long we want the client to run.
For a quick hunt this may be an hour or two but maybe for a DFIR
engagement it might be a few days. The GPO will ensure the client is
killed after the allotted time.</p><p><img src=9.png alt=image></p><p>Once the GPO is installed it becomes active for all domain machines. You
can now schedule any hunts you wish using the Velociraptor GUI. When a
domain machine refreshes its group policy it will run the client, which
will enroll and immediately participate in any outstanding hunts - thus
collecting and delivering its artifacts to the server. After the
allotted time has passed, the client will shut down without having
installed anything on the endpoint.</p><p>You can force a group policy update by running the gpupdate program. Now
you can verify that Velociraptor is running:</p><p><img src=10.png alt=image></p><h2 id=persistence>Persistence</h2><p>Note that when running Velociraptor in agent less mode you probably want
to configure it so that the writeback file is written to the temp
directory. The writeback file is how the client keeps track of its key
material (and identity). The default is to store it in the client's
installation folder, but you should probably change it in the client's
config file:</p><pre><code class=language-{.sourceCode data-lang={.sourceCode>Client:
  writeback_windows: $TEMP\\velociraptor.writeback.yaml
</code></pre><p>The file will remain in the client's temp directory so if you ever
decide to run the agentless client again (by pushing another group
policy) the client id remains the same.</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1623592976></script><script src=/js/perfect-scrollbar.min.js?1623592976></script><script src=/js/perfect-scrollbar.jquery.min.js?1623592976></script><script src=/js/jquery.sticky.js?1623592976></script><script src=/js/featherlight.min.js?1623592976></script><script src=/js/highlight.pack.js?1623592976></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1623592976></script><script src=/js/learn.js?1623592976></script><script src=/js/hugo-learn.js?1623592976></script></body></html>