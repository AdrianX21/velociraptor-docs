<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.3"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Extending VQL :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1625153676 rel=stylesheet><link href=/css/fontawesome-all.min.css?1625153676 rel=stylesheet><link href=/css/hybrid.css?1625153676 rel=stylesheet><link href=/css/featherlight.min.css?1625153676 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1625153676 rel=stylesheet><link href=/css/auto-complete.css?1625153676 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1625153676 rel=stylesheet><link href=/css/theme.css?1625153676 rel=stylesheet><link href=/css/tabs.css?1625153676 rel=stylesheet><link href=/css/hugo-theme.css?1625153676 rel=stylesheet><link href=/css/theme-mine.css?1625153676 rel=stylesheet><link href=/css/atom-one-light.css?1625153676 rel=stylesheet><link href=/css/dark.css?1625153676 rel=stylesheet><link href=/css/syntax.css?1625153676 rel=stylesheet><link href=/css/light.css?1625153676 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1625153676 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1625153676></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script></script></head><body data-url=/docs/extending_vql/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/self-signed/>Self Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/cloud/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/cloud/>Cloud Deployment</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/resources/>Performance</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile machine state</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class="dd-item parent active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/api/>The API</a></div></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Velociraptor Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Velociraptor Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/extending_vql/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Extending VQL</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#extending-vql---artifacts>Extending VQL - Artifacts</a><ul><li><a href=#extending-artifacts---powershell>Extending artifacts - PowerShell</a></li><li><a href=#dealing-with-output>Dealing with output</a></li><li><a href=#reusing-powershell-artifacts>Reusing powershell artifacts</a></li></ul></li><li><a href=#remediation>Remediation</a><ul><li><a href=#example-remediate-scheduled-tasks>Example: Remediate scheduled tasks</a></li></ul></li><li><a href=#using-external-tools>Using external tools</a><ul><li><a href=#the-autoruns-artifact>The Autoruns artifact</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Extending VQL</h1><p>VQL is really a glue language - we rely on VQL plugins and functions
to do all the heavy liftingm. VQL was never designed to be an all
powerful language - users will hit the limits of what is possible in
VQL pretty quickly.</p><p>To take full advantage of the power of VQL, we need to be able to
easily extend its functionality. This section illustrates how VQL can
be extended by including powershell scripts and external binaries.</p><p>For the ultimate level of control and automation, the Velociraptor API
can be used to interface directly to the Velociraptor server utilizing
many supported languages (like Java, C++, C#, Python).</p><h2 id=extending-vql---artifacts>Extending VQL - Artifacts</h2><p>The most obvious way for extending VQL is simply writing additional
artifacts. We have seen this done extensively in previous pages: Once
an artifact is added to Velociraptor, other artifacts can easily reuse
it by simply calling it.</p><p>Artifacts serve to encapsulate VQL queries and allow us to build more
complex content, but ultimately we are still limited with the basic
capabilities of the VQL engine. Adding more artifacts can not extend
the basic functionality provided by the built in VQL plugins and
functions.</p><h3 id=extending-artifacts---powershell>Extending artifacts - PowerShell</h3><p>Powershell is a powerful systems automation language mainly used on
Windows systems where is comes built in and almost always available.</p><p>Many complex software products contain powershell modules around
automation and system administration. It does not make sense for
Velociraptor to directly support complex software packages such as
Office365, Azure which already come with extensive powershell support.</p><p>But it is critical to be able to recover forensically relevant data
from these package. Therefore it makes sense to wrap powershell
scripts in VQL artifacts.</p><p>In the following we see how to wrap a simple powershell snippet in
VQL. The process for wrapping other powershell snippets is very
similar.</p><p>For this example we will use the following very simple snippet of
PowerShell which simply lists the names, process id and binary path of
all running processes.</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Get-Process</span> <span class=p>|</span> <span class=nb>Select </span><span class=n>Name</span><span class=p>,</span> <span class=n>Id</span><span class=p>,</span> <span class=n>Path</span>
</code></pre></div><p><img src=image8.png alt=Powershell></p><p>In order to run powershell code from Velociraptor we will use the
<code>execve()</code> plugin to shell out to powershell. The <code>execve()</code> plugin
takes a list of args and builds a correctly escaped command line.</p><div class="mynotices warning"><div><p>The <code>execve()</code> plugin takes a <strong>list</strong> of command line arguments
(i.e. <code>argv</code>). Velociraptor will combine this list into a valid
command line by itself taking care to escape specific args (On
Windows). Do not attempt to construct this list from a single command
line string, since this will likely produce an opportunity for
<a href=https://owasp.org/www-community/attacks/Command_Injection>Command Line
Injection</a>
if the commandline incorporates a user provided string.</p><p>Velociraptor minimizes the potential for this by requiring each
argument to be explicitely provided.</p></div></div><p>Here is a simple artifact that runs the powershell script via <code>execve()</code></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Custom.PowershellTest</span><span class=w>
</span><span class=w></span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>precondition</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=l>SELECT OS From info() where OS = &#39;windows&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>        LET PowershellScript = &#39;&#39;&#39;Get-Process | SELECT Name, Id, Path&#39;&#39;&#39;
</span><span class=sd>        SELECT * FROM execve(argv=[&#34;Powershell&#34;, &#34;-ExecutionPolicy&#34;,
</span><span class=sd>            &#34;unrestricted&#34;, &#34;-c&#34;, PowershellScript])</span><span class=w>        
</span></code></pre></div><p><img src=ps1.png alt="Extending with Powershell"></p><p>Collecting the artifact will result in the output of the powershell
script in an Stdout column.</p><p><img src=ps2.png alt="Extending with Powershell"></p><div class="mynotices tip"><div><p>In the above artifact we relied on Velociraptor to properly escape the
powershell script to the powershell interpreter on the
commandline. For more reliable encoding, we can base64 encode the
script:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>execve</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;Powershell&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-ExecutionPolicy&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=s2>&#34;unrestricted&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-EncodedCommand&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=n>base64encode</span><span class=p>(</span><span class=n>string</span><span class=o>=</span><span class=n>utf16_encode</span><span class=p>(</span><span class=n>string</span><span class=o>=</span><span class=n>PowershellScript</span><span class=p>))])</span><span class=w>
</span></code></pre></div><p>Alternative, we can write the Powershell script into a temporary file
and run it from there:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=w>        </span><span class=n>LET</span><span class=w> </span><span class=n>ps1</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>tempfile</span><span class=p>(</span><span class=n>extension</span><span class=o>=</span><span class=s2>&#34;.ps1&#34;</span><span class=p>,</span><span class=w> </span><span class=k>data</span><span class=o>=</span><span class=n>PowershellScript</span><span class=p>)</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>execve</span><span class=p>(</span><span class=w>
</span><span class=w>            </span><span class=n>argv</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;Powershell&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-ExecutionPolicy&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;unrestricted&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ps1</span><span class=p>)</span><span class=w>
</span></code></pre></div></div></div><h3 id=dealing-with-output>Dealing with output</h3><p>Using the <code>execve()</code> plugin we can see the output in the <code>Stdout</code>
column. However, it would be better to be able to deal with structured
output. Ideally we would like the powershell enabled artifact to
produce structured data that can be further processed by VQL.</p><p>We can use powershell&rsquo;s <code>ConvertTo-Json</code> to convert output to JSON,
and then use Velociraptor&rsquo;s <code>parse_json()</code> plugin to obtain structured
output.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Custom.PowershellTest</span><span class=w>
</span><span class=w></span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>precondition</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=l>SELECT OS From info() where OS = &#39;windows&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>        LET PowershellScript = &#39;&#39;&#39;Get-Process | SELECT Name, Id, Path | ConvertTo-Json&#39;&#39;&#39;
</span><span class=sd>        SELECT * FROM foreach(
</span><span class=sd>          row={
</span><span class=sd>            SELECT Stdout FROM execve(argv=[&#34;Powershell&#34;, &#34;-ExecutionPolicy&#34;,
</span><span class=sd>                &#34;unrestricted&#34;, &#34;-c&#34;, PowershellScript], length=1000000)
</span><span class=sd>          }, query={
</span><span class=sd>            SELECT * FROM parse_json_array(data=Stdout)
</span><span class=sd>        })</span><span class=w>        
</span></code></pre></div><p>Normally the <code>execve()</code> plugin emits a row with the child process&rsquo;s
Stdout as soon as data is available. However in this case, splitting
the output will break the JSON string and prevent Velociraptor from
properly parsing it. Therefore, we supply the <code>length=1000000</code>
parameter indicating that Stdout will be buffered up to the specified
length before emitting the row.</p><p><img src=ps3.png alt="Extending with Powershell"></p><p>Note how the output now appears as a regular table with rows and
columns. This allows VQL or operate on the result set as if it was
natively generated by a VQL plugin!</p><h3 id=reusing-powershell-artifacts>Reusing powershell artifacts</h3><p>Since our powershell script is now encapsulated, we can use it inside
other artifacts and plain VQL. Users of this artifact dont care what
the PowerShell Script is or what it does - we have encapsulation!</p><p><img src=ps4.png alt="Extending with Powershell"></p><h2 id=remediation>Remediation</h2><p>Remediation means to restore the network from a compromised state -
Usually remove persistence, and clean up infected machines. Unlike
traditional DFIR work that focuses on detection with minimal
interferance of the endpoint, remediation aims to modify the endpoint
in order to actively remove threats and harden the endpoint against
future compromise.</p><div class="mynotices warning"><div><p>Remediation is inherently risky! If a bug occurs that breaks the
endpoints, it is possible to damage the network quickly. Always
structure your artifacts so they show a dry run - what would have been
modified before actually performing the remediation.</p></div></div><h3 id=example-remediate-scheduled-tasks>Example: Remediate scheduled tasks</h3><p>For this example we will schedule a task to run daily. This emulates a
common persistance used by malware to re-infect the machine daily,
even after the machine is cleaned up.</p><div class=highlight><pre class=chroma><code class=language-ps1 data-lang=ps1><span class=n>SCHTASKS</span> <span class=p>/</span><span class=n>CREATE</span> <span class=p>/</span><span class=nb>SC </span><span class=n>DAILY</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;EvilTask&#34;</span> <span class=p>/</span><span class=n>TR</span> <span class=s2>&#34;dir c:&#34;</span> <span class=p>/</span><span class=n>ST</span> <span class=n>20</span><span class=err>:</span><span class=n>01</span>
</code></pre></div><p>First let us find our evil task by collecting the
<code>Windows.System.TaskScheduler</code> artifact.</p><p><img src=scheduled_tasks.png alt=TaskScheduler></p><p>Once we identify the malicious scheduled task we can remove it. An
example of such a remediation artifact is in
<code>Windows.Remediation.ScheduledTasks</code> artifact. Here is the relevant
VQL from that artifact.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>foreach</span><span class=p>(</span><span class=k>row</span><span class=o>=</span><span class=n>tasks</span><span class=p>,</span><span class=w>
</span><span class=w>  </span><span class=n>query</span><span class=o>=</span><span class=err>{</span><span class=w>
</span><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>condition</span><span class=o>=</span><span class=w> </span><span class=n>ReallyDoIt</span><span class=o>=</span><span class=s1>&#39;Y&#39;</span><span class=p>,</span><span class=w>
</span><span class=w>      </span><span class=k>then</span><span class=o>=</span><span class=err>{</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>FullPath</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>Command</span><span class=p>,</span><span class=w> </span><span class=n>Arguments</span><span class=p>,</span><span class=w> </span><span class=n>ComHandler</span><span class=p>,</span><span class=w> </span><span class=n>UserId</span><span class=p>,</span><span class=w> </span><span class=n>_XML</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>execve</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;powershell&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>           </span><span class=s2>&#34;-ExecutionPolicy&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Unrestricted&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-encodedCommand&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=n>base64encode</span><span class=p>(</span><span class=n>string</span><span class=o>=</span><span class=n>utf16_encode</span><span class=p>(</span><span class=w>
</span><span class=w>              </span><span class=n>string</span><span class=o>=</span><span class=n>format</span><span class=p>(</span><span class=n>format</span><span class=o>=</span><span class=n>script</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>Name</span><span class=p>])))</span><span class=w>
</span><span class=w>        </span><span class=p>])</span><span class=w>
</span><span class=w>      </span><span class=err>}</span><span class=p>,</span><span class=w> </span><span class=k>else</span><span class=o>=</span><span class=err>{</span><span class=w>
</span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>FullPath</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>Command</span><span class=p>,</span><span class=w> </span><span class=n>Arguments</span><span class=p>,</span><span class=w> </span><span class=n>ComHandler</span><span class=p>,</span><span class=w> </span><span class=n>UserId</span><span class=p>,</span><span class=w> </span><span class=n>_XML</span><span class=w>
</span><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=k>scope</span><span class=p>()</span><span class=w>
</span><span class=w>      </span><span class=err>}</span><span class=p>)</span><span class=w>
</span><span class=w>  </span><span class=err>}</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>Note the <code>ReallyDoIt</code> condition ensuring a dry run - if the parameter
is not set, the artifact will report all the tasks that match but will
not actually remove them.</p><p>We can perform a wider hunt to uncover potential malicious tasks and
see if any false postives will be found.</p><h2 id=using-external-tools>Using external tools</h2><p>Velociraptor is an extremely capable tool, but there will always be
situations where there will be a gap in its capabilities. We
previously saw how we can extend VQL using powershell, but what if we
have an external binary we would like to run on the endpoint?</p><p>We know how to shell out to an external binary using the <code>execve()</code>
plugin, but how do we ensure the binary exists on the endpoint in the
first place?</p><p>Velociraptor has the ability to manage external tools for artifacts
that need to use them:</p><ul><li>Velociraptor will ensure the tool is uploaded to the endpoint</li><li>If the tool version is updated, Velociraptor will ensure the new version is used.</li><li>Many artifacts need to use the same external binary each time, it
makes sense to cache the binary on the endpoint so subsequent
execution simply use the same binary.</li></ul><p>As an admin, you can control aspects of this process, such as require
the tool to be downloaded from a certain URL (e.g. an S3 bucket).</p><p>As an artifact writer you can specify your artifact will use a certain
tool and provide a hint of where to download it from.</p><h3 id=the-autoruns-artifact>The Autoruns artifact</h3><p>We will go through an example to understand this process. Let&rsquo;s
consider the <code>Windows.Sysinternals.Autoruns</code> artifact. This is a
commonly used artifact that launches the <code>autorunsc.exe</code> binary
(looking for common malware persistance) on the endpoint, collects the
output and converts the results to a table.</p><ol><li><p>The artifact defines an external tool by specifying the <code>tools</code>
attribute. The most important part is the <code>name</code> field, naming the
tool uniquely.</p><p>We can also provide a URL where the binary will be downloaded from
if required.</p></li></ol><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>Windows</span><span class=p>.</span><span class=n>Sysinternals</span><span class=p>.</span><span class=n>Autoruns</span><span class=w>
</span><span class=w></span><span class=n>tools</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=o>-</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>Autorun_amd64</span><span class=w>
</span><span class=w>    </span><span class=n>url</span><span class=p>:</span><span class=w> </span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>live</span><span class=p>.</span><span class=n>sysinternals</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>tools</span><span class=o>/</span><span class=n>autorunsc64</span><span class=p>.</span><span class=n>exe</span><span class=w>
</span></code></pre></div><ol start=2><li>Next we call the <code>Generic.Utils.FetchBinary</code> artifact within the
query in order to materialize the tool on the endpoint. In this
case we fetch the correct tool based on the architecture.</li></ol><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>sources</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=o>-</span><span class=w> </span><span class=n>query</span><span class=p>:</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w>      </span><span class=n>LET</span><span class=w> </span><span class=n>os_info</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>Architecture</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>info</span><span class=p>()</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=o>//</span><span class=w> </span><span class=k>Get</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=nb>binary</span><span class=p>.</span><span class=w>
</span><span class=w>      </span><span class=n>LET</span><span class=w> </span><span class=n>bin</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Artifact</span><span class=p>.</span><span class=n>Generic</span><span class=p>.</span><span class=n>Utils</span><span class=p>.</span><span class=n>FetchBinary</span><span class=p>(</span><span class=w>
</span><span class=w>              </span><span class=n>ToolName</span><span class=o>=</span><span class=w> </span><span class=s2>&#34;Autorun_&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>os_info</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>Architecture</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=n>ToolInfo</span><span class=o>=</span><span class=n>ToolInfo</span><span class=p>)</span><span class=w>
</span></code></pre></div><ol start=3><li>Next we simply run the tool and collect its output.</li></ol><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=w>      </span><span class=n>LET</span><span class=w> </span><span class=k>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>execve</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=p>[</span><span class=w>
</span><span class=w>           </span><span class=n>bin</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>FullPath</span><span class=p>,</span><span class=w>
</span><span class=w>           </span><span class=s1>&#39;-nobanner&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-accepteula&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-t&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-a&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;*&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-c&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;*&#39;</span><span class=p>],</span><span class=w>
</span><span class=w>           </span><span class=k>length</span><span class=o>=</span><span class=mi>10000000</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>Let&rsquo;s collect the artifact. Simply click &ldquo;New collection&rdquo; then search
for the autoruns artifact.</p><p><img src=autoruns.png alt=Autoruns></p><p>We immediately see the tools in the artifact description. These links
allow us to configure the tool. We can see the hash and the URL the
tool will be fetched from. The server keeps track of the binary hash
and requires it to match what was downloaded.</p><p><img src=tools.png alt=Autoruns></p><p>As an administrator we have the option to override the binary with our
own copy by uploading into the GUI. We can also provide an alternative
URL to serve the binary from.</p><p><img src=autoruns2.png alt=Autoruns></p><p>Once the artifact is launched we can see how it works from the query
logs:</p><ol><li>First the artifact waits for a random time in order to not
overwhelm the server.</li><li>Next the endpoint will download the binary from a server provided
URL. The server also tells the endpoint the tool&rsquo;s expected hash.</li><li>The endpoint compares the hash of the file it downloaded with the
expected hash.</li><li>Once the hashes agree, the endpoint will copy the executable into
the permanent cache directory.</li><li>The tool is now launched and the output parsed in VQL rows.</li></ol><div class="mynotices tip"><div><p>You can call any artifact from your own VQL regardless of whether they
use tools. For example, the <code>Windows.Sysinternals.Autoruns</code> artifact
can be used directly. Velociraptor will ensure dependent tools are
present on the endpoint for all dependencies.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Artifact</span><span class=p>.</span><span class=n>Windows</span><span class=p>.</span><span class=n>Sysinternals</span><span class=p>.</span><span class=n>Autoruns</span><span class=p>()</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>Category</span><span class=w> </span><span class=o>=~</span><span class=w> </span><span class=s2>&#34;Services&#34;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=o>`</span><span class=n>Launch</span><span class=w> </span><span class=n>String</span><span class=o>`</span><span class=w> </span><span class=o>=~</span><span class=w> </span><span class=s2>&#34;COMSPEC&#34;</span><span class=w>
</span></code></pre></div></div></div><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1625153676></script><script src=/js/perfect-scrollbar.min.js?1625153676></script><script src=/js/perfect-scrollbar.jquery.min.js?1625153676></script><script src=/js/jquery.sticky.js?1625153676></script><script src=/js/featherlight.min.js?1625153676></script><script src=/js/highlight.pack.js?1625153676></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1625153676></script><script src=/js/learn.js?1625153676></script><script src=/js/hugo-learn.js?1625153676></script></body></html>