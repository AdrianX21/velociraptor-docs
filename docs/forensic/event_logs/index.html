<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.1"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Event Logs :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1624873606 rel=stylesheet><link href=/css/fontawesome-all.min.css?1624873606 rel=stylesheet><link href=/css/hybrid.css?1624873606 rel=stylesheet><link href=/css/featherlight.min.css?1624873606 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1624873606 rel=stylesheet><link href=/css/auto-complete.css?1624873606 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1624873606 rel=stylesheet><link href=/css/theme.css?1624873606 rel=stylesheet><link href=/css/tabs.css?1624873606 rel=stylesheet><link href=/css/hugo-theme.css?1624873606 rel=stylesheet><link href=/css/theme-mine.css?1624873606 rel=stylesheet><link href=/css/atom-one-light.css?1624873606 rel=stylesheet><link href=/css/dark.css?1624873606 rel=stylesheet><link href=/css/light.css?1624873606 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1624873606 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1624873606></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script></script></head><body data-url=/docs/forensic/event_logs/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/self-signed/>Self Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/cloud/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/cloud/>Cloud Deployment</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/resources/>Performance</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class="dd-item parent active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Offline Triage</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/api/>The API</a></div></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Velociraptor Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Velociraptor Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/forensic/event_logs/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Event Logs</span></div><div class=progress><div class=wrapper><nav id=TableOfContents></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Event Logs</h1><p>Windows Event Logs</p><p>Windows event logs
Stored in files with extension of *.evtx typically in C:\Windows\System32\WinEVT\Logs*.evtx</p><p>File format features:
Rollover - File is divided into chunks and new chunks can overwrite older chunks
Binary XML format provides compression
Structured records with strong types
30</p><p>Parsing EVTX
31
The event message is actually written in XML but Velociraptor convert it into a JSON object to make it easier to filter specific fields.</p><p>Event significant fields
Provider, Channel, Computer - this represents the source of the message
Event ID - An index into the message table identifying the type of this event
EventRecordID - The ID of this message within the evtx file.
UserData - An application specific blob of structured data
32</p><p>Event Messages
Windows Event Logs architecture does NOT store the event message in the evtx file!
This allows for event message internationalization
Saves some small amount of space in the evtx files themselves
But mostly makes it difficult to analyze offline
Grabbing all the EVTX files off the system may result in loss of event messages!
33</p><p>34</p><p>35
The event description message contains vital context about what the event actually means.
Without the message we would need to search for the event id.</p><p>36
Event message search
If you copied the event log files off the system and do not have access to the messages, you will need to figure out what does the event id mean.</p><p>Some common event ids are documented publicly.</p><p>Deriving event messages
Using the provider, channel and computer name lookup the registry key
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog&lt;channel>&lt;provider>
Read the value EventMessageFile.
This will point at a DLL path, open the resource section of this dll for a Message Table resource. This will produce a formatted string. Interpolate the UserData section into the string.
37</p><p>Deriving event messages
Open the DLL, and locate the resource section in the PE file of this dll, searching for a Message Table resource.</p><p>A MESSAGE_TABLE resource is a list of strings - the Event ID is an index into this table.</p><p>This will produce a string with expansion directives like %1, %2 etc. Interpolate the UserData section into the string.
38</p><p>39</p><p>40
Resolving Messages
Velociraptor can automatically follow this process when parsing event logs using the parse_evtx() plugin.
Notice the UserData is expanded into the messages.</p><p>What could go wrong?
If you just collect the EVTX files from one system to another you will lose access to message tables, because the messages are in DLL files scattered across the entire system.</p><p>If an application is uninstalled, its message DLLs will be removed and earlier events are not able to be displayed any more.
41</p><p>Event Message databases
The <a href=https://github.com/Velocidex/evtx-data>https://github.com/Velocidex/evtx-data</a> repository contains sqlite databases of many known message tables collected from different systems.</p><p>The dumpevtx tool can resolve messages from these databases and the sqlite databases.
42</p><p>Event logs DFIR
43</p><p>Exercise - resolve messages
Clone the evtx-data repository to your Linux machine. Download the dumpevtx tool from the releases page.</p><p>View the event log samples on your Linux machine using the dumpevtx tool. Note that no messages are present.</p><p>Download the relevant sqlite message databases and resolve messages from your evtx files.
44</p><p>45
The dumpevtx tool emits JSON data. You can use the jq tool to reformat the JSON data to remove un-needed fields.</p><p>46
SELECT timestamp(epoch=System.TimeCreated.SystemTime) AS Timestamp,
Message,
get(field=&lsquo;EventData&rsquo;) AS EventData
FROM parse_evtx(filename=EVTX, messagedb=MSG)</p><p>References
<a href=https://www.appliedincidentresponse.com/windows-event-log-analyst-reference/>https://www.appliedincidentresponse.com/windows-event-log-analyst-reference/</a></p><p><a href=https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-logon>https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-logon</a></p><p>47</p><p>Disabling event logs
Event logs can be easily disabled.</p><p>48</p><p>What is the setting?
49</p><p>Exercise: Detect disabled logs
Write an artifact that reports the state of each log channel (enabled/disabled)</p><p>Use the Microsoft-Windows-Bits-Client/Operational channel as an example
50</p><p>Convert to an artifact
51</p><p>Event Tracing for Windows
52</p><p>What is ETW
ETW is the underlying system by which event logs are generated and collected.
<a href=https://docs.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw>https://docs.microsoft.com/en-us/windows-hardware/test/weg/instrumenting-your-code-with-etw</a></p><p>53</p><p>ETW Providers
Show all registered ETW providers</p><p>Show details about each provider</p><p>54
logman query providers
logman query providers Microsoft-Windows-DNS-Client</p><p>ETW for event driven logs
ETW and event logs are just two sides of the same coin
Log providers are just ETW providers</p><p>In VQL watch_etw() can be used
instead of watch_evtx()</p><p>See Windows.Sysinternals.SysmonLogForward
for an example
55</p><p>Exercise - Monitor DNS queries
Use ETW to monitor all clients' DNS queries.</p><p>Stream queries to server
56</p><p>Exercise - Monitor DNS queries
57</p><p>58</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1624873606></script><script src=/js/perfect-scrollbar.min.js?1624873606></script><script src=/js/perfect-scrollbar.jquery.min.js?1624873606></script><script src=/js/jquery.sticky.js?1624873606></script><script src=/js/featherlight.min.js?1624873606></script><script src=/js/highlight.pack.js?1624873606></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1624873606></script><script src=/js/learn.js?1624873606></script><script src=/js/hugo-learn.js?1624873606></script></body></html>