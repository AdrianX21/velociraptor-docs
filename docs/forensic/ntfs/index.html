<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=description content="NTFS is the standard Windows filesystem. Velociraptor contains powerful NTFS analysis capabilities.
"><link rel=icon href=/images/favicon.png type=image/png><title>NTFS Analysis :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1625539377 rel=stylesheet><link href=/css/fontawesome-all.min.css?1625539377 rel=stylesheet><link href=/css/featherlight.min.css?1625539377 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1625539377 rel=stylesheet><link href=/css/auto-complete.css?1625539377 rel=stylesheet><link href=/css/theme.css?1625539377 rel=stylesheet><link href=/css/tabs.css?1625539377 rel=stylesheet><link href=/css/hugo-theme.css?1625539377 rel=stylesheet><link href=/css/theme-mine.css?1625539377 rel=stylesheet><link href=/css/atom-one-light.css?1625539377 rel=stylesheet><link href=/css/dark.css?1625539377 rel=stylesheet><link href=/css/syntax.css?1625539377 rel=stylesheet><link href=/css/light.css?1625539377 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1625539377 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1625539377></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script></script></head><body data-url=/docs/forensic/ntfs/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp('theme=darkmode');regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/self-signed/>Self Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/cloud/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/cloud/>Cloud Deployment</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/deployment/resources/>Performance</a></div></li></ul></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item parent haschildren"><div><i class="fa fa-angle-down fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class="dd-item parent active"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile machine state</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/api/>The API</a></div></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Velociraptor Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Velociraptor Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class="fas fa-search"></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class="fab fa-discord"></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class="fas fa-envelope"></i>Mailing List</a></li></ul></section><section id=footer><div class=footer-copyright>Brough to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2021</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/scudette/velociraptor-docs/edit/master/content/docs/forensic/ntfs/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>NTFS Analysis</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#the-master-file-table>The Master File Table</a></li><li><a href=#the-ntfs-accessor>The <code>ntfs</code> accessor</a></li><li><a href=#volume-shadow-copies>Volume Shadow Copies</a></li><li><a href=#operating-on-vss>Operating on VSS</a></li><li><a href=#parsing-the-mft>Parsing the MFT</a></li><li><a href=#mft-entries>MFT Entries</a></li><li><a href=#ntfs-timestamps>NTFS timestamps</a><ul><li><a href=#timestomping>Timestomping</a></li></ul></li><li><a href=#timeline-analysis>Timeline analysis</a></li><li><a href=#the-i30-indx-stream>The $I30 INDX stream</a></li><li><a href=#the-usn-journal>The USN journal</a><ul><li><a href=#parsing-usn-journal>Parsing USN journal</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>NTFS Analysis</h1><p>NTFS is the standard Windows filesystem. Velociraptor contains
powerful NTFS analysis capabilities. This section describes
Velociraptor&rsquo;s NTFS capabilities and does not aim to be a complete
description of NTFS itself. We will only introduce the basic and most
relevant concepts of NTFS and examine how these can be used in a
number of DFIR contexts.</p><h2 id=the-master-file-table>The Master File Table</h2><p>In NTFS, all files are represented in a <a href=https://docs.microsoft.com/en-us/windows/win32/fileio/master-file-table>Master File Table (MFT)</a>. The
MFT is also a file within the filesystem with the special filename of
<code>$MFT</code>. While this special file is normally hidden by the API,
Velociraptor&rsquo;s NTFS parser makes it available to view, read or upload.</p><p>The <code>$MFT</code> file contains a sequence of <code>MFT Entries</code>, each of a fixed
size (usually 512 bytes). These entries contain metadata about files,
called <code>File Attributes</code>. The different attributes contain different
kinds of information about each file:</p><ul><li>Filename (Long name/Short name)</li><li>Data attribute – contains file data runs.</li><li>I30 attribute (contains directory listing)</li><li>Security attributes such as ACLs</li></ul><p><img src=image22.png alt=MFT></p><p>Data attributes may be compressed or sparse and contain a list of <code>runs</code> that comprize the content of the file. The data content is stored elsewhere on the disk, but the location is stored within the MFT entry.</p><p>In NTFS Each file may contain two different filenames, a long and a
short filename. Filename attributes contain their own timestamps.</p><div class="mynotices warning"><div><p>Although NTFS long and short filenames are usually closely related
(e.g. the short filename is the first part of the long filename with a
suffix such as <code>%1</code>), this is not a requirement.</p><p>It is very easy to create a file with a completely different short
filename to its long filename. This can be problematic if you are
looking for references to the long filename from e.g. registry keys.</p><p>In the below example, I set the shortname of the <code>velociraptor.exe</code>
binary to <code>runme.exe</code>. I can then create a service that launches
<code>runme.exe</code> instead. Tools that only show the long filename of the
directory will fail to show the file and analysis may conclude that
the service target is missing from the filesystem.</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>C:<span class=se>\U</span>sers<span class=se>\t</span>est&gt;fsutil file setshortname velociraptor.exe runme.exe
C:<span class=se>\U</span>sers<span class=se>\t</span>est&gt;dir /x *.exe
 Volume in drive C has no label.
 Volume Serial Number is 9459-F443

 Directory of C:<span class=se>\U</span>sers<span class=se>\t</span>est

08/19/2018  11:37 PM        12,521,472 RUNME.EXE    velociraptor.exe
               <span class=m>2</span> File<span class=o>(</span>s<span class=o>)</span>     16,140,732 bytes
               <span class=m>0</span> Dir<span class=o>(</span>s<span class=o>)</span>  11,783,704,576 bytes free
C:<span class=se>\U</span>sers<span class=se>\t</span>est&gt;runme.exe -h
usage: velociraptor <span class=o>[</span>&lt;flags&gt;<span class=o>]</span> &lt;command&gt; <span class=o>[</span>&lt;args&gt; ...<span class=o>]</span>
</code></pre></div></div></div><h2 id=the-ntfs-accessor>The <code>ntfs</code> accessor</h2><p>Velociraptor has a complete NTFS parser able to access files and
directories by parsing the raw NTFS filesystem from the raw device. To
make it easy to utilize this parser with VQL, Velociraptor implements
the <code>ntfs</code> accessor (For a description of accessors, see <a href=/docs/forensic/filesystem/#filesystem-accessors>here</a> ).</p><p>The <code>ntfs</code> accessor makes it possible to see and access the normally
hidden NTFS files such as <code>$MFT</code>. It also makes it possible to see
Alternate Data Streams (ADS), which are additional data streams
attached to the same MFT entry.</p><p><img src=image24.png alt="NTFS accessor"></p><p>The NTFS accessor makes NTFS specific information available in the
Data field. For regular files it includes the inode string, as well as
the short filename.</p><p>When providing a path to the <code>ntfs</code> accessor, the first part of the
path is interpreted as the <code>drive letter</code> or the <code>device part</code>.</p><p>For example providing a path starting with <code>C:</code> or <code>D:</code>, will be
converted internally to Windows device notation, for example <code>\\.\C:</code>
or <code>\\.\D:</code>. The <code>ntfs</code> accessor then uses this to open the raw
logical device so it can be parsed.</p><p>This means that all paths returned from the <code>ntfs</code> accessor start with
the device name, e.g. <code>\\.\C:</code>.</p><div class="mynotices tip"><div><p>Since Velociraptor operated on the logical device it if not affected
by full disk encryption such as Bitlocker. Velociraptor will be able
to parse the raw NTFS filesystem regardless of the disk encryption
status.</p></div></div><h2 id=volume-shadow-copies>Volume Shadow Copies</h2><p>NTFS allows for a special copy on write snapshot feature called
<code>Volume Shadow Copy</code> or <code>VSS</code>. You can think of a VSS as a light
weight snapshot of the current filesystem without needing to copy any
data (future writes will simply be diverted to the current active
snapshot).</p><p>On server class Windows systems, you can create a VSS copy on your own
machine using <code>vssadmin create shadow</code>, but on other Windows versions
you will need to do this via WMI:</p><p><img src=image33.png alt="Creating shadow copy"></p><p>When a VSS copy is created, it is accessible via a special
device. Velociraptor allows the VSS copies to be enumerated by listing
them at the top level of the filesystem. At the top level, the
accessor provides metadata about each device in the <code>Data</code> column,
including its creation time. This is essentially the same output as
<code>vssadmin list shadows</code>. In the below screenshot we can see the <code>Data</code>
column of the fixed <code>C:</code> drive and the VSS device.</p><p><img src=image28.png alt="VSS info"></p><h2 id=operating-on-vss>Operating on VSS</h2><p>Because the <code>ntfs</code> accessor treats all devices at the first top level
directory, it is possible to see the same file in all VSS copies at
the same time. For example, the following finds all VSS copies of the
event logs:</p><p><img src=image31.png alt="VSS globbing"></p><p>Simply use the VSS device name as a prefix to all paths and the ntfs
accessor will parse it instead.</p><p>You can use it to analyze older versions of the drive!</p><h2 id=parsing-the-mft>Parsing the MFT</h2><p>Since the <code>ntfs</code> accessor allows accessing the <code>$MFT</code> file as a
regular file, you can download the entire $MFT file from the endpoint
using the ntfs accessor, then process it offline. For example using
the <code>Windows.Search.FileFinder</code> artifact with the <code>ntfs</code> accessor - or
simply using the VQL:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=n>upload</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;C:/$MFT&#34;</span><span class=p>,</span><span class=w> </span><span class=n>accessor</span><span class=o>=</span><span class=s2>&#34;ntfs&#34;</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=k>scope</span><span class=p>()</span><span class=w>
</span></code></pre></div><p>However, in practice this is inefficient and does not scale. Typically
we want to parse the MFT in order to answer some questions about the
system, such as which files were modified within a timerange.</p><p>Velociraptor provides access to the $MFT parser using the
<code>parse_mft()</code> plugin, so the MFT can be parsed directly on the
endpoint using Velociraptor. The plugin emits a high level summary of
each MFT entry, including its timestamps (for the
$STANDARD_INFORMATION and $FILENAME streams) and MFT ID.</p><p>This plugin is most useful when you need to pass over all the files in
the disk - it is more efficient than a recursive glob and might
recover deleted files. For example to recover all the files with a
.exe extension from the drive:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>parse_mft</span><span class=p>(</span><span class=n>filename</span><span class=o>=</span><span class=s2>&#34;C:/$MFT&#34;</span><span class=p>,</span><span class=w> </span><span class=n>accessor</span><span class=o>=</span><span class=s2>&#34;ntfs&#34;</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>FileName</span><span class=w> </span><span class=o>=~</span><span class=w> </span><span class=s2>&#34;.exe$&#34;</span><span class=w>
</span></code></pre></div><h2 id=mft-entries>MFT Entries</h2><p>An MFT Entry can have multiple attributes and streams. While
<code>parse_mft()</code> plugin emits a high level summary for each entry,
sometimes we need more information on each MFT entry. This information
is provided by the <code>parse_ntfs()</code> VQL function which accepts and MFT
ID:</p><p><img src=image39.png alt="Parse ntfs"></p><p>The MFT ID can be take from the output of <code>glob()</code> or <code>parse_mft()</code>.</p><div class="mynotices tip"><div><p>In the above you will sometimes see the term <code>inode</code> referred to. This
term traditionally comes from the Sleuthkit and is a string consisting
of a triple of mft id, type id and stream id, e.g. <code>974-16-0</code>
representing a stream of data</p></div></div><h2 id=ntfs-timestamps>NTFS timestamps</h2><p>A single MFT entry can have up to 16 timestamps, based on different
attributes:</p><ul><li>The $STANDARD_INFORMATION attribute contains 4 timestamps (Modified, Accessed, indoe Changed, Born)</li><li>There are often 2 $FILENAME attributes for a short name and a long name, each will have 4 further timestamps.</li><li>The $I30 stream of the parent directory also contains 4 timestamps for the file.</li></ul><p>Timestamps are critical to forensic investigations as they help to
establish a timeline of activity on the system.</p><h3 id=timestomping>Timestomping</h3><p>Attackers sometimes change the timestamps of files to make them less
obvious. E.g make malware look like it was installed many years
ago. This makes timelines more difficult to establish and might cause
you to miss important filesystem events.</p><p>For the next exercise we will stomp over some times. Use the following
powershell to stomp over Velociraptor.exe’s timestamps.</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=nv>$file</span> <span class=p>=</span> <span class=s1>&#39;C:\Program Files\Velociraptor\Velociraptor.exe&#39;</span>
<span class=nv>$stomp</span> <span class=p>=</span> <span class=nb>Get-Date</span> <span class=n>2007</span><span class=p>-</span><span class=n>07</span><span class=p>-</span><span class=n>07</span>
<span class=p>$(</span><span class=nb>Get-Item</span> <span class=nv>$file</span><span class=p>).</span><span class=n>creationtime</span> <span class=p>=</span> <span class=nv>$stomp</span>
<span class=p>$(</span><span class=nb>Get-Item</span> <span class=nv>$file</span><span class=p>).</span><span class=n>lastaccesstime</span> <span class=p>=</span> <span class=nv>$stomp</span>
<span class=p>$(</span><span class=nb>Get-Item</span> <span class=nv>$file</span><span class=p>).</span><span class=n>lastwritetime</span> <span class=p>=</span> <span class=nv>$stomp</span>
<span class=nb>Get-ChildItem</span> <span class=nv>$file</span> <span class=p>|</span> <span class=nb>Select </span><span class=p>*,</span> <span class=n>Fullname</span><span class=p>,</span> <span class=p>*</span><span class=n>Time</span><span class=p>*</span>
</code></pre></div><p><img src=image44.png alt=Before>
<img src=image38.png alt=After></p><p>The above script uses the API to change the times of a file but this
only changes the $STANDARD_INFORMATION stream. The real times are
still present on the $FILENAME attributes. A common detection to this
is to find files which have $STANDARD_INFORMATION times earlier then
the $FILENAME times. When the file is created, $FILENAME times are set
to the real times, then if the API is used to send the timestamps
backwards the $STANDARD_INFORMATION timestamps will appear earlier
than the $FILENAME times.</p><p><img src=image42.png alt="Timestomp detection"></p><div class="mynotices warning"><div><p>Although it might appear to be a solid detection to timestomping,
generally timestomping detections are not very reliable in
practice. It turns out that a lot of programs set file timestamps
after creating them into the past by design - mostly archiving
utilities like 7zip or cab will reset the file time to the times
stored in the archive.</p><p>Conversely it might appear that the $FILENAME times are the most
reliable and should be mostly relied upon in an investigation since
they are not directly modifiable by the Win32 APIs.</p><p>Unfortunately this is not the case - the $FILENAME attributes can be
easily modified by simply renaming the file (after timestomping) and
rename it back. Windows will copy the timestamps from the
$STANDARD_INFORMATION attribute to the $FILENAME when renaming the
file.</p></div></div><h2 id=timeline-analysis>Timeline analysis</h2><p>Timelines in forensic analysis are very important as they place events
in chronological order and may reveal causal relationships. We can
get a timeline by sorting the table on the modified or birth
timestamps.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>parse_mft</span><span class=p>(</span><span class=n>filename</span><span class=o>=</span><span class=s2>&#34;C:/$MFT&#34;</span><span class=p>,</span><span class=w> </span><span class=n>accessor</span><span class=o>=</span><span class=s2>&#34;ntfs&#34;</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>Created0x30</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=s2>&#34;2020-01-02&#34;</span><span class=w>
</span><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>Created0x30</span><span class=w>
</span></code></pre></div><p>It is more efficient to narrow the time of interest first.</p><h2 id=the-i30-indx-stream>The $I30 INDX stream</h2><p>In NTFS a directory is simply an MFT entry with $I30 streams. The
streams contains a B+ tree of the MFT entries in the directory.</p><p>Since INDX streams are a B+ tree when a record is deleted, the tree
will be reordered. Sometimes this leaves old entries in the slack
space. INDX stream is allocated in 4096 byte blocks which leaves a lot
of slack space to potentially hold residual data.</p><p><img src=image54.png alt="I30 slack"></p><p>Velociraptor can report on the $I30 streams and carve out headers from slack using the parse_ntfs_i30() function as duscussed in <a href=https://www.fireeye.com/blog/threat-research/2012/10/incident-response-ntfs-indx-buffers-part-4-br-internal.html>this article</a>. An example query:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>foreach</span><span class=p>(</span><span class=w>
</span><span class=w>   </span><span class=k>row</span><span class=o>=</span><span class=err>{</span><span class=w>
</span><span class=w>     </span><span class=k>SELECT</span><span class=w> </span><span class=n>FullPath</span><span class=p>,</span><span class=w> </span><span class=k>Data</span><span class=p>.</span><span class=n>mft</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>MFT</span><span class=w>
</span><span class=w>     </span><span class=k>FROM</span><span class=w> </span><span class=n>glob</span><span class=p>(</span><span class=n>globs</span><span class=o>=</span><span class=n>DirectoryGlobs</span><span class=p>,</span><span class=w> </span><span class=n>accessor</span><span class=o>=</span><span class=s2>&#34;ntfs&#34;</span><span class=p>)</span><span class=w>
</span><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>IsDir</span><span class=w>
</span><span class=w>   </span><span class=err>}</span><span class=p>,</span><span class=w>
</span><span class=w>   </span><span class=n>query</span><span class=o>=</span><span class=err>{</span><span class=w>
</span><span class=w>     </span><span class=k>SELECT</span><span class=w> </span><span class=n>FullPath</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>NameType</span><span class=p>,</span><span class=w> </span><span class=k>Size</span><span class=p>,</span><span class=w> </span><span class=n>AllocatedSize</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=n>IsSlack</span><span class=p>,</span><span class=w> </span><span class=n>SlackOffset</span><span class=p>,</span><span class=w> </span><span class=n>Mtime</span><span class=p>,</span><span class=w> </span><span class=n>Atime</span><span class=p>,</span><span class=w> </span><span class=n>Ctime</span><span class=p>,</span><span class=w> </span><span class=n>Btime</span><span class=p>,</span><span class=w> </span><span class=n>MFTId</span><span class=w>
</span><span class=w>     </span><span class=k>FROM</span><span class=w> </span><span class=n>parse_ntfs_i30</span><span class=p>(</span><span class=n>device</span><span class=o>=</span><span class=n>FullPath</span><span class=p>,</span><span class=w> </span><span class=n>inode</span><span class=o>=</span><span class=n>MFT</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=err>}</span><span class=p>)</span><span class=w>
</span></code></pre></div><h2 id=the-usn-journal>The USN journal</h2><p>Update Sequence Number Journal or Change journal is maintained by NTFS
to record filesystem changes. Prmiarily designed to support backup
programs, the USN journal records metadata about filesystem changes.</p><p>The journal resides in the path <code>$Extend\$UsnJrnl:$J</code> and is normally
a hidden NTFS internal file (so it can only be accessed via the <code>ntfs</code>
accessor).</p><p>Windows appends USN records to the end of the file. However, the file
is sparse - periodically NTFS will remove the range at the start of
the file to make it sparse and preserve disk space.</p><p>Typically the file will report a huge size but will actually only take
about 30-40mb on disk since the first part of the file is sparse.</p><p><img src=image43.png alt="The USN journal"></p><p>When collecting the journal file, Velociraptor will collect the sparse
file only (Velociraptor is aware of sparse files and preserves their
sparse ranges by adding an additional <code>.idx</code> file to the collection
with the ranges containing real data. You can see this in the
<code>Uploaded Files</code> tab of the collection - the file size is reported to
be very large, however only about 30mb was actually collected.</p><p><img src=image47.png alt="The USN journal collected"></p><div class="mynotices tip"><div><p>Downloading the file from the <code>Uploaded Files</code> tab will pad the sparse regions and produce a large file with ranges of 0 in it. On the other hand, exporting the zip file from the <code>Overview</code> tab will store the collected file and the idx range file into the zip file so will only store about 30mb.</p></div></div><h3 id=parsing-usn-journal>Parsing USN journal</h3><p>Velociraptor can parse each entry in the USN journal directly on the
endpoint. This allows for queries to target specific files or times of
interest on the endpoint.</p><p>Since the beginning of the file is sparse, we start parsing from the
first valid range.</p><p>The USN journal may record interactions with files that have been
removed. Many files represent evidence of system interaction (such as
lnk files or prefetch files) and the USN journal can therefore uncover
the &ldquo;smoking gun&rdquo; when the system was initially compromised.</p><p><img src=image60.png alt="The USN journal"></p><p>You can collect the USN journal using the <code>Windows.Forensics.Usn</code>
artifact.</p><div class="mynotices tip"><div><p>The USN journal contains so much valuable evidence that it might be worth carving for USN records from the raw disk. Although this is a slow process it can yield very good results if your are lucky - see <a href=/blog/2021/2021-06-16-carving-usn-journal-entries-72d5c66971da/>this blog post</a> for more information.</p></div></div><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1625539377></script><script src=/js/perfect-scrollbar.min.js?1625539377></script><script src=/js/perfect-scrollbar.jquery.min.js?1625539377></script><script src=/js/jquery.sticky.js?1625539377></script><script src=/js/featherlight.min.js?1625539377></script><script src=/js/highlight.pack.js?1625539377></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1625539377></script><script src=/js/learn.js?1625539377></script><script src=/js/hugo-learn.js?1625539377></script></body></html>