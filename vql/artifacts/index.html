<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.83.1"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Artifacts :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1623743079 rel=stylesheet><link href=/css/fontawesome-all.min.css?1623743079 rel=stylesheet><link href=/css/hybrid.css?1623743079 rel=stylesheet><link href=/css/featherlight.min.css?1623743079 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1623743079 rel=stylesheet><link href=/css/auto-complete.css?1623743079 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1623743079 rel=stylesheet><link href=/css/theme.css?1623743079 rel=stylesheet><link href=/css/tabs.css?1623743079 rel=stylesheet><link href=/css/hugo-theme.css?1623743079 rel=stylesheet><link href=/css/theme-mine.css?1623743079 rel=stylesheet><link href=/css/atom-one-light.css?1623743079 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1623743079 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1623743079></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/vql/artifacts/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){alert("Switch to dark mode")}</script><div class="btn btn-default ThemeSelector" onclick=darkmode()><i class="fas fa-moon"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=/overview/ title="Velociraptor Overview" class=dd-item><a href=/overview/>Velociraptor Overview</a><ul><li data-nav-id=/overview/history/ title=History class=dd-item><a href=/overview/history/>History</a></li><li data-nav-id=/overview/deployment/ title="Deployment Overview" class=dd-item><a href=/overview/deployment/>Deployment Overview</a><ul><li data-nav-id=/overview/deployment/self-signed/ title="Self Signed SSL" class=dd-item><a href=/overview/deployment/self-signed/>Self Signed SSL</a></li><li data-nav-id=/overview/deployment/cloud/ title="Cloud Deployment" class=dd-item><a href=/overview/deployment/cloud/>Cloud Deployment</a></li><li data-nav-id=/overview/deployment/clients/ title="Deploying Clients" class=dd-item><a href=/overview/deployment/clients/>Deploying Clients</a></li><li data-nav-id=/overview/deployment/rbac/ title="Users and Roles" class=dd-item><a href=/overview/deployment/rbac/>Users and Roles</a></li><li data-nav-id=/overview/deployment/resources/ title=Performance class=dd-item><a href=/overview/deployment/resources/>Performance</a></li></ul></li></ul></li><li data-nav-id=/gui/ title="The Admin GUI" class=dd-item><a href=/gui/>The Admin GUI</a><ul><li data-nav-id=/gui/clients/ title="Inspecting clients" class=dd-item><a href=/gui/clients/>Inspecting clients</a></li><li data-nav-id=/gui/vfs/ title="The VFS" class=dd-item><a href=/gui/vfs/>The VFS</a></li><li data-nav-id=/gui/artifacts/ title=Artifacts class=dd-item><a href=/gui/artifacts/>Artifacts</a></li><li data-nav-id=/gui/hunting/ title=Hunting class=dd-item><a href=/gui/hunting/>Hunting</a></li></ul></li><li data-nav-id=/vql/ title="VQL Fundamentals" class="dd-item
parent"><a href=/vql/>VQL Fundamentals</a><ul><li data-nav-id=/vql/notebooks/ title=Notebooks class=dd-item><a href=/vql/notebooks/>Notebooks</a></li><li data-nav-id=/vql/artifacts/ title=Artifacts class="dd-item
parent
active"><a href=/vql/artifacts/>Artifacts</a></li></ul></li><li data-nav-id=/vql_reference/ title="VQL Reference" class=dd-item><a href=/vql_reference/>VQL Reference</a><ul><li data-nav-id=/vql_reference/basic/ title="Basic VQL functions and plugins" class=dd-item><a href=/vql_reference/basic/>Basic VQL</a></li><li data-nav-id=/vql_reference/windows/ title="Windows Specific Functionality" class=dd-item><a href=/vql_reference/windows/>Windows</a></li><li data-nav-id=/vql_reference/parsers/ title="Parsers and data extractors" class=dd-item><a href=/vql_reference/parsers/>Parsers</a></li><li data-nav-id=/vql_reference/server/ title="Server Side Functionality" class=dd-item><a href=/vql_reference/server/>Server</a></li><li data-nav-id=/vql_reference/plugin/ title="Client Side Functionality" class=dd-item><a href=/vql_reference/plugin/>Client</a></li><li data-nav-id=/vql_reference/event/ title="Event Plugins" class=dd-item><a href=/vql_reference/event/>Event Plugins</a></li><li data-nav-id=/vql_reference/experimental/ title="Experimental Functionality" class=dd-item><a href=/vql_reference/experimental/>Experimental</a></li></ul></li><li data-nav-id=/training/ title="Velociraptor Training" class=dd-item><a href=/training/>Training</a></li><li data-nav-id=/blog/ title="Velociraptor Blog" class=dd-item><a href=/blog/>Blog</a><ul><li data-nav-id=/blog/2021/ title=2021 class=dd-item><a href=/blog/2021/>2021</a><ul><li data-nav-id=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/ title="Concurrent VQL" class=dd-item><a href=/blog/2021/2021-01-22-concurrent-vql-6d381fdb0b1f/>Concurrent VQL</a></li><li data-nav-id=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/ title="Parsing binary files" class=dd-item><a href=/blog/2021/2021-01-19-parsing-binary-files-d31114a41f14/>Parsing binary files</a></li></ul></li><li data-nav-id=/blog/2020/ title=2020 class=dd-item><a href=/blog/2020/>2020</a><ul><li data-nav-id=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/ title="Slack and Velociraptor" class=dd-item><a href=/blog/2020/2020-12-26-slack-and-velociraptor-b63803ba4b16/>Slack and Velociraptor</a></li><li data-nav-id=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/ title="Velociraptor and OSQuery" class=dd-item><a href=/blog/2020/2020-12-13-velociraptor-and-osquery-2a4306dd23c/>Velociraptor and OSQuery</a></li><li data-nav-id=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/ title="The Windows USN Journal" class=dd-item><a href=/blog/2020/2020-11-13-the-windows-usn-journal-f0c55c9010e/>The Windows USN Journal</a></li><li data-nav-id=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/ title="Velociraptor Communications" class=dd-item><a href=/blog/2020/2020-09-28-velociraptor-network-communications-30568624043a/>Velociraptor Communications</a></li><li data-nav-id=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/ title="Velociraptor SSO Authentication" class=dd-item><a href=/blog/2020/2020-08-17-velociraptor-sso-authentication-6dd68d46dccf/>Velociraptor SSO Authentication</a></li><li data-nav-id=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/ title="Profiling the beast" class=dd-item><a href=/blog/2020/2020-08-16-profiling-the-beast-58913437fd16/>Profiling the beast</a></li><li data-nav-id=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/ title="Triage with Velociraptor — Pt 4" class=dd-item><a href=/blog/2020/2020-07-14-triage-with-velociraptor-pt-4-cf0e60810d1e/>Triage with Velociraptor — Pt 4</a></li><li data-nav-id=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/ title="Velociraptor in the tool age" class=dd-item><a href=/blog/2020/2020-07-13-velociraptor-in-the-tool-age-d896dfe71b9/>Velociraptor in the tool age</a></li><li data-nav-id=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/ title="The Velociraptor Query Language Pt 2" class=dd-item><a href=/blog/2020/2020-06-19-the-velociraptor-query-language-pt-2-fe92bb7aa150/>The Velociraptor Query Language Pt 2</a></li><li data-nav-id=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/ title="The Velociraptor Query Language Pt 1" class=dd-item><a href=/blog/2020/2020-06-14-the-velociraptor-query-language-pt-1-d721bff100bf/>The Velociraptor Query Language Pt 1</a></li><li data-nav-id=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/ title=Velociraptor class=dd-item><a href=/blog/2020/2020-04-16-velociraptor-e48a47e0317d/>Velociraptor</a></li><li data-nav-id=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/ title="Velociraptor’s ACL model" class=dd-item><a href=/blog/2020/2020-03-29-velociraptors-acl-model-7f497575daee/>Velociraptor’s ACL model</a></li><li data-nav-id=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/ title="Velociraptor notebooks" class=dd-item><a href=/blog/2020/2020-03-28-velociraptor-notebooks-d02e0bd11230/>Velociraptor notebooks</a></li><li data-nav-id=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/ title="Extending VQL plugins" class=dd-item><a href=/blog/2020/2020-03-07-extending-vql-plugins-7fb004cb6ec4/>Extending VQL plugins</a></li><li data-nav-id=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/ title="Velociraptor Post-processing with Jupyter Notebook and Pandas" class=dd-item><a href=/blog/2020/2020-03-06-velociraptor-post-processing-with-jupyter-notebook-and-pandas-8a344d05ee8c/>Velociraptor Post-processing with Jupyter Notebook and Pandas</a></li><li data-nav-id=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/ title="Hunting Malware using Mutants" class=dd-item><a href=/blog/2020/2020-01-12_hunting-malware-using-mutants-ea08e86dfc19/>Hunting Malware using Mutants</a></li></ul></li><li data-nav-id=/blog/2019/ title=2019 class=dd-item><a href=/blog/2019/>2019</a><ul><li data-nav-id=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/ title="Digging into the System Resource Usage Monitor (SRUM)" class=dd-item><a href=/blog/2019/2019-12-31_digging-into-the-system-resource-usage-monitor-srum-afbadb1a375/>Digging into the System Resource Usage Monitor (SRUM)</a></li><li data-nav-id=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/ title="Velociraptor to Elasticsearch" class=dd-item><a href=/blog/2019/2019-12-08-velociraptor-to-elasticsearch-3a9fc02c6568/>Velociraptor to Elasticsearch</a></li><li data-nav-id=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/ title="Recovering deleted NTFS Files with Velociraptor" class=dd-item><a href=/blog/2019/2019-11-15_recovering-deleted-ntfs-files-with-velociraptor-1fcf09855311/>Recovering deleted NTFS Files with Velociraptor</a></li><li data-nav-id=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/ title="Windows Event Logs" class=dd-item><a href=/blog/2019/2019-11-12_windows-event-logs-d8d8e615c9ca/>Windows Event Logs</a></li><li data-nav-id=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/ title="Triage with Velociraptor — Pt 3" class=dd-item><a href=/blog/2019/2019-10-08_triage-with-velociraptor-pt-3-d6f63215f579/>Triage with Velociraptor — Pt 3</a></li><li data-nav-id=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/ title="Triage with Velociraptor — Pt 2" class=dd-item><a href=/blog/2019/2019-10-04_triage-with-velociraptor-pt-2-d0f79066ca0e/>Triage with Velociraptor — Pt 2</a></li><li data-nav-id=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/ title="Triage with Velociraptor — Pt 1" class=dd-item><a href=/blog/2019/2019-10-02_triage-with-velociraptor-pt-1-253f57ce96c0/>Triage with Velociraptor — Pt 1</a></li><li data-nav-id=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/ title="Velociraptor’s client side buffer" class=dd-item><a href=/blog/2019/2019-09-11_velociraptor-s-client-side-buffer-3ce03697a4e6/>Velociraptor’s client side buffer</a></li><li data-nav-id=/blog/2019/2019-03-02/ title="Agentless hunting with Velociraptor" class=dd-item><a href=/blog/2019/2019-03-02/>Agentless hunting with Velociraptor</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://docs.velociraptor.app/search><i class="fas fa-search"></i> Search</a></li><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Artifacts</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#parameters>Parameters</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Artifacts</h1><p>Velociraptor allows packaging VQL queries inside mini-programs called
<code>Artifacts</code>. An artifact is simply a structured YAML file containing a
query, with a name attached to it. This allows Velociraptor users to
search for the query by name or description and simply run the query
on the endpoint without necessaily needing to understand or type the
query into the UI.</p><p>Therefore Artifacts can be thought of as VQL modules.</p><p>Usually an artifact is geared towards collecting a single type of
information from the endpoint. For example consider the following
artifact:</p><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Custom.Artifact.Name<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>|<span style=color:#ba2121;font-style:italic>
</span><span style=color:#ba2121;font-style:italic>   </span><span style=color:#bbb>   </span>This is the human readable description of the artifact.<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>CLIENT<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>parameters</span>:<span style=color:#bbb>
</span><span style=color:#bbb>   </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>FirstParameter<span style=color:#bbb>
</span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span>Default Value of first parameter<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>MySource<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>precondition</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>SELECT OS From info() where OS = &#39;windows&#39; OR OS = &#39;linux&#39; OR OS = &#39;darwin&#39;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>query</span>:<span style=color:#bbb> </span>|<span style=color:#ba2121;font-style:italic>
</span><span style=color:#ba2121;font-style:italic>      SELECT * FROM info()
</span><span style=color:#ba2121;font-style:italic>      LIMIT 10</span><span style=color:#bbb>      
</span></code></pre></div><p>The Artifact contains a number of important parameters:</p><ol><li>Name: The artifact contains a name. By convention the name is
segmented by dots in a hierarchy. The Name appears in the GUI and
can be searched on.</li><li>Description: Artifacts contain a human readable description. The
description field is also searchable in the GUI and so should
contain relevant keywords that make the artifact more discoverable.</li><li>Type: The type of the Artifact. Since Velociraptor uses VQL in many
different contexts, the type of the artifact hints to the GUI where
the artifact is meant to run. For example, a CLIENT artifact is
meant to be run on the endpoint, while a SERVER artifact is meant
to be run on the server. The artifact type is only relevant for the
GUI.</li><li>Parameters: An artifact may declare parameters, in which case they
may be set by the GUI user to customize the artifact collection.</li><li>Sources: The artifact may define a number of VQL sources to
generate result tables. Each source generates a single table. If
more than one source is given, they must all have unique names.</li><li>Precondition: A source may define a precondition query. This query
will be run prior to collecting the source. If it returns no rows
then the collection will be skipped. Preconditions make it safe to
collect artifacts from all hosts (e.g. in a hunt), and ensure that
only artifacts that make sense to collect are actually run.</li><li>Query: The query that will be used to collect that source. Note
that since each source <strong>must</strong> produce a single table, the query
should have exactly one <code>SELECT</code> clause and it must be at the end
of the query potentially following any <code>LET</code> queries.</li></ol><h2 id=parameters>Parameters</h2><p>Artifact parameters allow the user to customize the collection in a
controlled way - without needing to edit the VQL. The GUI will present
a form that allows the user to update the parameters prior to each
collection.</p><p>Parameters may define a type. This type will be used to hint to the
GUI how to render the form element. The type also determines how the
parameter is sent to the client and ensures the parameter appears as
that type in the query.</p><p>Prior to launching the query on the endpoint, Velociraptor will
populate the scope with the parameters. This allows the VQL query to
directly access the parameters.</p><p>Artifact parameters are sent to the client as strings
The client automatically parses them into a VQL type depending on the parameter&rsquo;s type specification.
The GUI uses type specification to render an appropriate UI</p><p>Parameter types
Currently these are supported:
int, integer: The parameter is an integer
timestamp: The parameter is a timestamp
csv: Parameter appears as a list of dicts formatted as a CSV
json: Parameter is a JSON encoded dict
json_array: The parameter is a list of dicts encoded as a JSON blob (similar to csv)
bool: The parameter is a boolean (TRUE/YES/Y/OK)</p><p>70</p><p>71
Exercise: Create an artifact
Convert our previous VQL to an artifact. Developing artifacts is easy to do:
Go to the View Artifacts screen
Select Add new artifact
Modify the template, paste your VQL in it.
When you save the artifact the artifact will be ready for collection.</p><p>72
Make a WMI Subprocess artifact
We generally want to make artifacts reusable:</p><p>Artifacts take parameters that users can customized when collecting
The parameters should have obvious defaults
Artifacts have precondition queries that determine if the artifact will run on the endpoint.
Description field is searchable so make it discoverable&mldr;</p><p>73
name: Custom.Windows.Detection.WmiSubprocess
description: |
Detect processes spawned from WMI</p><h1 id=can-be-client-client_event-server-server_event>Can be CLIENT, CLIENT_EVENT, SERVER, SERVER_EVENT</h1><p>type: CLIENT</p><p>parameters:</p><ul><li>name: ProcessName
default: cmd.exe</li></ul><p>sources:</p><ul><li><p>precondition:
SELECT OS From info() where OS = &lsquo;windows&rsquo; OR OS = &lsquo;linux&rsquo; OR OS = &lsquo;darwin&rsquo;</p><p>query: |
SELECT Name, Pid, Username, CommandLine, {
SELECT Name, Pid FROM pslist(pid=Ppid)
} As Parent
FROM pslist()
WHERE Name =~ ProcessName AND Parent.Name =~ &ldquo;Wmi&rdquo;</p></li></ul><p>74
Your artifact is ready to collect
Let&rsquo;s create a hunt to find all currently running command shells from wmi across our entire deployment.</p><p>Find out in seconds&mldr;
75</p><p>Artifact writing tips
Use the notebook to write VQL on the target platform.
Start small - one query at a time
Inspect the result, figure out what information is available - refine
Use LET stored queries generously.
You can essentially comment out queries by using LET - eg.
LET X = SELECT * FROM pslist()
LET Y = SELECT * FROM netstat()
SELECT * FROM X
76
Will not run since Y is lazy</p><p>Artifact writing tips
Use the log() VQL function to provide print debugging.
Use format(format="%T %v", args=[X, X]) to learn about a value&rsquo;s type and value
77</p><p>Calling artifacts from VQL
You can call other artifacts from your own VQL using the
“Artifact.<artifact name>” plugin notation.
Args to the Artifact() plugin are passed as artifact parameters.</p><p>78
When calling artifacts types are not converted. Make sure you pass the expected types</p><p>VQL and times
Inside the VQL query, variables have strong types. Usually a type is a dict but sometimes it is a something else (Use format="%T")
Timestamps are given as time.Time types. They have some common methods. VQL can call any method that does not take args:
Unix, UnixNano - number of seconds since the epoch
Day, Minute, Month etc - convert time to days minutes etc.
Timestamps compare to strings&mldr;</p><p>When times are serialized to JSON they get ISO format strings in UTC.
79</p><p>VQL and times
To convert to a time type use the timestamp() VQL function
Takes an epoch or string arg - can be a string or int - tries to do the right thing.</p><p>Use the now() function to get the current epoch offset</p><p>80</p><p>Exercise: Identify recent accounts
Write an artifact to identify local accounts logged in since February</p><p>81
Use the timestamp() function to parse times from seconds, strings, winfiletime etc.</p><p>Format time</p><p>Format time like 4 February 2021 10:23:00</p><p>82</p><p>83</p><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1623743079></script><script src=/js/perfect-scrollbar.min.js?1623743079></script><script src=/js/perfect-scrollbar.jquery.min.js?1623743079></script><script src=/js/jquery.sticky.js?1623743079></script><script src=/js/featherlight.min.js?1623743079></script><script src=/js/highlight.pack.js?1623743079></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1623743079></script><script src=/js/learn.js?1623743079></script><script src=/js/hugo-learn.js?1623743079></script></body></html>